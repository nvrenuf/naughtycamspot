---
import { withBase } from '../../utils/links';
import { isPagesBuild } from '../../utils/links';

const pagesBuild = isPagesBuild();
const formAction = pagesBuild ? withBase('/apply/') : withBase('/claim/index.php');
const formMethod = pagesBuild ? 'get' : 'post';
const csrfEndpoint = pagesBuild ? '' : withBase('/claim/token.php');

const searchParams = Astro.url.searchParams;
const trackingKeys = ['src', 'camp', 'date'] as const;
const trackingParams = new URLSearchParams();
for (const key of trackingKeys) {
  const value = searchParams.get(key);
  if (value) {
    trackingParams.set(key, value);
  }
}

const src = trackingParams.get('src') ?? '';
const camp = trackingParams.get('camp') ?? '';
const date = trackingParams.get('date') ?? '';
const page = Astro.url.pathname;
---
<section class="scroll-mt-24 px-6 pb-6 pt-2" id="startright-kit">
  <div class="mx-auto max-w-6xl rounded-3xl border border-white/10 bg-white/5 p-6 shadow-glow">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
      <div class="space-y-2">
        <p class="text-xs uppercase tracking-[0.3em] text-rose-petal/70">StartRight kit</p>
        <h2 class="font-display text-3xl text-white sm:text-4xl">Need the checklist after choosing your path?</h2>
        <p class="max-w-2xl text-sm text-white/75">
          Open the kit form when you are ready. We only contact 18+ creators who opt in.
        </p>
      </div>
    </div>
    <details class="mt-5 rounded-2xl border border-white/10 bg-black/20 p-4" data-kit-toggle>
      <summary class="inline-flex cursor-pointer list-none items-center justify-center rounded-full border border-rose-gold/50 bg-rose-gold/15 px-5 py-3 text-xs font-semibold uppercase tracking-[0.28em] text-rose-petal transition hover:border-rose-gold/70 hover:bg-rose-gold/30 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rose-gold">
        Get StartRight Kit
      </summary>
      <form class="mt-5 grid gap-4 sm:grid-cols-4" method={formMethod} action={formAction} data-lead-capture>
        <input type="hidden" name="lead_form" value="1" />
        <input type="hidden" name="csrf_token" value="" data-csrf-token />
        <input type="hidden" name="source" value="lead_magnet" />
        <input type="hidden" name="page" value={page} />
        <input type="hidden" name="src" value={src} />
        <input type="hidden" name="camp" value={camp} />
        <input type="hidden" name="date" value={date} />

        <label class="flex flex-col gap-2 text-xs uppercase tracking-[0.25em] text-white/60 sm:col-span-2">
          Email (optional)
          <input
            type="email"
            name="email"
            autocomplete="email"
            placeholder="you@example.com"
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm normal-case tracking-normal text-white placeholder:text-white/35 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rose-gold"
          />
        </label>

        <label class="flex flex-col gap-2 text-xs uppercase tracking-[0.25em] text-white/60">
          Telegram (optional)
          <input
            type="text"
            name="telegram"
            autocomplete="off"
            placeholder="@yourhandle"
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm normal-case tracking-normal text-white placeholder:text-white/35 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rose-gold"
          />
        </label>

        <label class="flex flex-col gap-2 text-xs uppercase tracking-[0.25em] text-white/60">
          WhatsApp (optional)
          <input
            type="text"
            name="whatsapp"
            autocomplete="tel"
            placeholder="+1 555 000 0000"
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm normal-case tracking-normal text-white placeholder:text-white/35 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rose-gold"
          />
        </label>

        <label class="flex items-start gap-3 rounded-2xl border border-white/10 bg-white/5 px-4 py-4 text-xs uppercase tracking-[0.22em] text-white/70 sm:col-span-3">
          <input class="mt-1 h-4 w-4 accent-rose-gold" type="checkbox" name="consent" required />
          I am 18+ and I opt in to receive setup messages from NaughtyCamSpot.
        </label>

        <button
          data-claim-submit
          type="submit"
          class="inline-flex items-center justify-center rounded-full border border-rose-gold/50 bg-rose-gold/15 px-5 py-4 text-xs font-semibold uppercase tracking-[0.28em] text-rose-petal transition hover:border-rose-gold/70 hover:bg-rose-gold/30"
        >
          Get checklist
        </button>
        <p class="hidden text-xs normal-case tracking-normal text-rose-petal sm:col-span-4" data-token-error role="alert">
          Please refresh and try again.
        </p>
      </form>
    </details>

    <p class="mt-4 text-xs text-white/60">
      No passwords. No exclusivity. You own your accounts and content. Cancel anytime.
    </p>
  </div>
  {!pagesBuild && (
    <script is:inline define:vars={{ csrfEndpoint }}>
      {`(function () {
  const tokenInput = document.querySelector('[data-lead-capture] [data-csrf-token]');
  const form = document.querySelector('[data-lead-capture]');
  const submitButton = form instanceof HTMLFormElement
    ? form.querySelector('[data-claim-submit]')
    : null;
  const tokenError = form instanceof HTMLFormElement
    ? form.querySelector('[data-token-error]')
    : null;
  if (!(tokenInput instanceof HTMLInputElement) || !csrfEndpoint || !(form instanceof HTMLFormElement)) {
    return;
  }

  if (submitButton instanceof HTMLButtonElement) {
    submitButton.disabled = true;
    submitButton.setAttribute('aria-disabled', 'true');
  }

  fetch(csrfEndpoint, {
    method: 'GET',
    credentials: 'same-origin',
    headers: { Accept: 'application/json' }
  })
    .then((response) => (response.ok ? response.json() : null))
    .then((data) => {
      if (!data || typeof data.token !== 'string' || data.token.trim() === '') {
        throw new Error('Missing token');
      }
      tokenInput.value = data.token;
      if (submitButton instanceof HTMLButtonElement) {
        submitButton.disabled = false;
        submitButton.removeAttribute('aria-disabled');
      }
      if (tokenError instanceof HTMLElement) {
        tokenError.classList.add('hidden');
      }
    })
    .catch(() => {
      if (submitButton instanceof HTMLButtonElement) {
        submitButton.disabled = true;
        submitButton.setAttribute('aria-disabled', 'true');
      }
      if (tokenError instanceof HTMLElement) {
        tokenError.classList.remove('hidden');
      }
    });
})();`}
    </script>
  )}
</section>
