---
import { getCollection } from 'astro:content';
import { withBase } from '../../utils/links';

const phaseOneSlugs = [
  'getting-started-cam-model-checklist',
  'marketing-yourself-on-multiple-platforms',
  'understanding-affiliate-programmes-benefits',
  'equipment-essentials-on-a-budget',
  'privacy-safety-and-wellbeing-online'
] as const;

const allPosts = (await getCollection('blog'))
  .filter((entry) => !entry.data.vipOnly)
  .slice()
  .sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime());

const phaseOneSet = new Set<string>(phaseOneSlugs);
const phaseOnePosts = allPosts.filter((post) => phaseOneSet.has(post.slug));
const fallbackPosts = allPosts.filter((post) => !phaseOneSet.has(post.slug));
const recentPosts = [...phaseOnePosts, ...fallbackPosts].slice(0, 5);

const trackingKeys = ['src', 'camp', 'date'] as const;
const trackingParams = new URLSearchParams();
for (const key of trackingKeys) {
  const value = Astro.url.searchParams.get(key);
  if (value) {
    trackingParams.set(key, value);
  }
}
const trackingQuery = trackingParams.toString();
const buildPostHref = (slug: string) => {
  const baseHref = withBase(`/posts/${slug}`);
  if (!trackingQuery) {
    return baseHref;
  }
  return `${baseHref}?${trackingQuery}`;
};
---
<section class="px-6 py-16">
  <div class="mx-auto max-w-6xl space-y-6">
    <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-rose-petal/70">Recent blog posts</p>
        <h2 class="font-display text-3xl text-white sm:text-4xl">Latest recruiting + promotion insights</h2>
      </div>
      <a class="text-sm uppercase tracking-[0.3em] text-rose-gold transition hover:text-white" href={withBase('/blog/')}>
        Browse blog
      </a>
    </div>
    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      {recentPosts.map((post) => (
        <article class="content-card space-y-3">
          <p class="text-xs uppercase tracking-[0.25em] text-rose-petal/70">{post.data.category}</p>
          <h3 class="font-display text-2xl text-white">{post.data.title}</h3>
          <p class="text-sm text-white/70">{post.data.excerpt}</p>
          <a class="inline-flex text-xs uppercase tracking-[0.28em] text-rose-gold transition hover:text-white" href={buildPostHref(post.slug)}>
            Read post
          </a>
        </article>
      ))}
    </div>
  </div>
</section>
