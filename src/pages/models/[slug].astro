---
import BannerSlot from '../../components/BannerSlot.astro';
import SEO from '../../components/SEO.astro';
import MainLayout from '../../layouts/MainLayout.astro';
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import { buildTrackedLink, withBase } from '../../utils/links';

type ModelEntry = CollectionEntry<'models'>;
type ModelPlatform = ModelEntry['data']['platforms'][number];

const resolveTrackingValue = (value: string | undefined, fallback: string) => {
  if (!value) {
    return fallback;
  }
  const trimmed = value.trim();
  return trimmed.length > 0 ? trimmed : fallback;
};

export async function getStaticPaths() {
  const models = await getCollection('models');

  return models.map((model) => ({
    params: { slug: model.id },
    props: {
      model,
      related: models.filter((item) => item.id !== model.id).slice(0, 3)
    }
  }));
}

const { model, related } = Astro.props as {
  model: ModelEntry;
  related: ModelEntry[];
};

const data = model.data;
const canonicalPath = Astro.url.pathname;
const slotPrefix = resolveTrackingValue(data.tracking?.slotPrefix, model.id.replace(/-/g, '_'));
const profileCamp = resolveTrackingValue(data.tracking?.profileCamp, `${slotPrefix}_profile`);
const beaconsCamp = resolveTrackingValue(data.tracking?.beaconsCamp, model.id);
const siteUrl = import.meta.env.SITE ?? 'https://naughtycamspot.com';

const sameAsCandidates = [
  ...data.profiles,
  ...data.platforms
    .map((platform) => platform.placeholder)
    .filter((value): value is string => {
      if (!value) {
        return false;
      }

      return /^https?:\/\//i.test(value);
    })
];

const personJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Person',
  name: data.name,
  url: new URL(canonicalPath, siteUrl).toString(),
  sameAs: Array.from(new Set(sameAsCandidates))
};

const buildHref = (platform: ModelPlatform) => {
  const placeholder = platform.placeholder ?? '';

  if (platform.kind === 'beacons') {
    return buildTrackedLink({
      path: platform.path,
      slot: 'model_page',
      camp: beaconsCamp,
      placeholder
    });
  }

  return buildTrackedLink({
    path: platform.path,
    slot: `${slotPrefix}_${platform.slug}`,
    camp: profileCamp,
    placeholder
  });
};

const activePlatforms = data.platforms;
const relatedCards = related.map((entry) => ({
  slug: entry.id,
  name: entry.data.name,
  archetype: entry.data.archetype,
  image: entry.data.cardImage ?? entry.data.heroImage
}));
---

<MainLayout
  title={`${data.name} | NaughtyCamSpot Model Profile`}
  description={`Discover ${data.name} — ${data.archetype} within the NaughtyCamSpot concierge gallery.`}
>
  <SEO
    slot="head"
    title={`${data.name} | NaughtyCamSpot Model Profile`}
    description={`Discover ${data.name}'s curated rituals, signature lighting, and concierge-run conversions.`}
    path={canonicalPath}
    ogImage={data.heroImage}
    ogType="profile"
  />
  <script type="application/ld+json">{JSON.stringify(personJsonLd)}</script>

  <!-- SECTION: Hero -->
  <section class="glass overflow-hidden rounded-[42px] px-10 py-14">
    <div class="grid gap-12 lg:grid-cols-[1.15fr_0.85fr]">
      <div class="space-y-6">
        <span class="inline-flex w-fit items-center gap-2 rounded-full border border-white/10 bg-white/10 px-4 py-2 text-xs uppercase tracking-[0.4em] text-rose-petal/80">
          Model profile
        </span>
        <div class="space-y-4">
          <h1 class="font-display text-5xl text-white sm:text-6xl">{data.name}</h1>
          <p class="text-sm uppercase tracking-[0.3em] text-rose-petal/80">{data.archetype}</p>
          <p class="max-w-2xl text-base leading-relaxed text-white/70">
            {data.summary}
          </p>
        </div>
        <div class="space-y-3">
          <p class="text-xs uppercase tracking-[0.4em] text-rose-petal/70">Platform lineup</p>
          <div class="flex flex-wrap gap-3" data-test={`${model.id}-platform-buttons`}>
            {activePlatforms.map((platform) => (
              platform.active !== false ? (
                <a
                  data-platform={platform.slug}
                  class={`rounded-full border px-6 py-2 text-xs font-semibold uppercase tracking-[0.28em] shadow-glow transition hover:-translate-y-1 ${
                    platform.variant === 'primary'
                      ? 'border-rose-gold/60 bg-rose-gold text-midnight'
                      : 'border-rose-gold/40 bg-rose-gold/15 text-rose-petal hover:bg-rose-gold/25'
                  }`}
                  href={buildHref(platform)}
                  target="_blank"
                  rel="noreferrer"
                >
                  {platform.name}
                </a>
              ) : (
                <span
                  data-platform={platform.slug}
                  class="rounded-full border border-white/15 bg-white/5 px-6 py-2 text-xs uppercase tracking-[0.28em] text-white/40"
                  aria-disabled="true"
                >
                  {platform.name} • Inactive
                </span>
              )
            ))}
          </div>
        </div>
      </div>
      <div class="relative space-y-6">
        <div class="pointer-events-none absolute -top-16 right-4 hidden h-36 w-36 rounded-full bg-rose-gold/30 blur-3xl lg:block"></div>
        <div class="glass relative overflow-hidden rounded-[38px]">
          <img src={data.heroImage} alt={data.name} class="h-full w-full object-cover" loading="lazy" />
        </div>
        <!-- SLOT: model_sidebar_tall -->
        <BannerSlot id="model_sidebar_tall" />
      </div>
    </div>
  </section>

  <!-- SLOT: model_mid_rectangle -->
  <BannerSlot id="model_mid_rectangle" class="mt-16" />

  <!-- SECTION: Gallery -->
  <section class="space-y-8">
    <h2 class="section-heading">Gallery &amp; Atmosphere</h2>
    <div class="grid gap-6 sm:grid-cols-3">
      {data.gallery.map((item, index) => (
        <div class="glass overflow-hidden rounded-3xl" style={`animation-delay: ${index * 0.1}s`}>
          <img src={item} alt={`${data.name} gallery ${index + 1}`} class="h-56 w-full object-cover" loading="lazy" />
        </div>
      ))}
    </div>
    <div class="grid gap-4 sm:grid-cols-3">
      <div class="video-placeholder">Video Teaser</div>
      <div class="video-placeholder">Behind the Scenes</div>
      <div class="video-placeholder">Fan-Favorite Moment</div>
    </div>
  </section>

  {relatedCards.length > 0 && (
    <section class="space-y-6">
      <h2 class="section-heading">Related Models</h2>
      <div class="flex snap-x gap-6 overflow-x-auto pb-4">
        {relatedCards.map((item) => (
          <a class="min-w-[260px] flex-shrink-0 content-card space-y-3" href={withBase(`/models/${item.slug}`)}>
            <img src={item.image} alt={item.name} class="h-40 w-full rounded-3xl object-cover" loading="lazy" />
            <div>
              <p class="font-display text-xl text-white">{item.name}</p>
              <p class="text-xs uppercase tracking-[0.3em] text-rose-petal/70">{item.archetype}</p>
            </div>
          </a>
        ))}
      </div>
    </section>
  )}
</MainLayout>
