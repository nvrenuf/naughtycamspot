---
import MainLayout from '../layouts/MainLayout.astro';
import SEO from '../components/SEO.astro';
import { PLATFORMS } from '../data/platforms';
import { withBase } from '../utils/links';
import { getRequestLang, t } from '../i18n/core';

const canonicalPath = '/apply';
const lang = getRequestLang(Astro.url);
const searchParams = Astro.url.searchParams;
const src = searchParams.get('src') ?? '';
const camp = searchParams.get('camp') ?? '';
const date = searchParams.get('date') ?? '';
const packageChoice = searchParams.get('package') ?? '';
const kitUnlock = searchParams.get('kit') === '1';
const success = searchParams.get('success') === '1';
const tokenError = searchParams.get('err') === 'token';
const formAction = withBase('/claim/index.php');
const csrfEndpoint = withBase('/claim/token.php');
const timezoneOptions = [
  'PT',
  'MT',
  'CT',
  'ET',
  'AK',
  'HI',
  'UTC',
  'Other'
];
const dayOptions = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
const timeOptions = [
  '06:00',
  '07:00',
  '08:00',
  '09:00',
  '10:00',
  '11:00',
  '12:00',
  '13:00',
  '14:00',
  '15:00',
  '16:00',
  '17:00',
  '18:00',
  '19:00',
  '20:00',
  '21:00',
  '22:00',
  '23:00',
  '00:00',
  '01:00',
  '02:00'
];
const styleOptions = [
  { value: 'gfe', label: 'GFE' },
  { value: 'tease', label: 'Tease' },
  { value: 'domme', label: 'Domme/Femdom' },
  { value: 'roleplay', label: 'Roleplay' },
  { value: 'couples', label: 'Couples' },
  { value: 'fetish', label: 'Fetish' },
  { value: 'gnd', label: 'Girl-next-door' },
  { value: 'other', label: 'Other' }
];
const hardNoOptions = [
  { value: 'meetups', label: 'Meetups' },
  { value: 'face', label: 'Face reveal' },
  { value: 'public', label: 'Public shows' },
  { value: 'custom', label: 'Custom requests' },
  { value: 'off_platform', label: 'Off-platform contact' },
  { value: 'extreme', label: 'Extreme fetish' },
  { value: 'explicit', label: 'Explicit content' },
  { value: 'dom', label: 'D/s themes' }
];
---

<MainLayout
  title="Apply | NaughtyCamSpot"
  description="Apply for Signup Help (Free), Promotion (Paid), or both."
>
  <SEO
    slot="head"
    title="Apply | NaughtyCamSpot"
    description="Apply for Signup Help (Free), Promotion (Paid), or both."
    path={canonicalPath}
  />

  <section class="content-card space-y-6">
    <div class="space-y-3">
      <p class="hero-tagline">{t(lang, 'apply.tag')}</p>
      <h1 class="font-display text-4xl text-white sm:text-5xl">
        {t(lang, 'apply.title')}
      </h1>
      <p class="max-w-2xl text-base text-white/70">
        {t(lang, 'apply.sub')}
      </p>
    </div>

    {success && (
      <div class="rounded-2xl border border-rose-gold/40 bg-rose-gold/10 px-5 py-4 text-sm text-white/80">
        Application received. The NaughtyCamSpot team will follow up shortly.
      </div>
    )}
    {tokenError && (
      <div class="rounded-2xl border border-rose-gold/40 bg-rose-gold/10 px-5 py-4 text-sm text-white/85" role="alert">
        Security check expired. Please try again.
      </div>
    )}

    <section class="rounded-2xl border border-white/10 bg-white/5 p-4" data-apply-progress aria-live="polite">
      <p class="text-xs uppercase tracking-[0.3em] text-rose-petal/70" data-current-step>Step 1 of 4</p>
      <div class="mt-3 h-2 rounded-full bg-white/10">
        <div class="h-2 w-1/4 rounded-full bg-rose-gold transition-all duration-200" data-progress-fill></div>
      </div>
      <div class="mt-3 grid grid-cols-2 gap-2 text-xs sm:grid-cols-4">
        <span class="rounded-full border border-rose-gold/50 bg-rose-gold/20 px-3 py-2 text-center text-rose-petal" data-step-label="1">Fast Lane</span>
        <span class="rounded-full border border-white/10 bg-white/5 px-3 py-2 text-center text-white/60" data-step-label="2">Optional</span>
        <span class="rounded-full border border-white/10 bg-white/5 px-3 py-2 text-center text-white/60" data-step-label="3">Profile</span>
        <span class="rounded-full border border-white/10 bg-white/5 px-3 py-2 text-center text-white/60" data-step-label="4">Finish</span>
      </div>
    </section>

    <form class="grid gap-6 sm:grid-cols-2" method="post" action={formAction}>
      <input type="hidden" name="lead_form" value="1" />
      <input type="hidden" name="csrf_token" value="" data-csrf-token />
      <input type="hidden" name="src" value={src} />
      <input type="hidden" name="camp" value={camp} />
      <input type="hidden" name="date" value={date} />
      <input type="hidden" name="package" value={packageChoice} />
      {kitUnlock && <input type="hidden" name="kit_unlock" value="1" />}

      <section class="space-y-5 rounded-2xl border border-rose-gold/30 bg-rose-gold/10 p-5 sm:col-span-2" data-apply-step="1">
        <p class="text-xs uppercase tracking-[0.3em] text-rose-petal/70">Fast Lane</p>
        <div class="rounded-2xl border border-rose-gold/30 bg-rose-gold/10 px-5 py-4 text-sm text-white/80">
          <p class="text-xs uppercase tracking-[0.3em] text-white/70">Trust rules</p>
          <p class="mt-2 text-xs uppercase tracking-[0.3em] text-white/70">
            {t(lang, 'apply.fastlane.trust')}
          </p>
        </div>

        <label class="flex flex-col gap-2 text-sm text-white/70">
          {t(lang, 'apply.fastlane.telegram')}
          <input
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white"
            type="text"
            name="telegram"
            placeholder="@yourhandle"
            autocomplete="off"
            required
          />
        </label>
        <p class="text-xs text-white/65">Telegram gets the fastest reply from our setup team.</p>

        <div class="space-y-3">
          <p class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">{t(lang, 'apply.fastlane.platform_interest')}</p>
          <p class="text-xs text-white/60">Choose one or more platforms.</p>
          <div class="grid gap-2 sm:grid-cols-2">
            {PLATFORMS.map((platform) => (
              <label class="flex items-center gap-3 rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-sm text-white/70">
                <input
                  class="h-4 w-4 accent-rose-gold"
                  type="checkbox"
                  name="platforms_interested[]"
                  value={platform.slug}
                />
                <span class="text-white">{platform.name}</span>
              </label>
            ))}
          </div>
        </div>

        <label class="flex items-start gap-3 rounded-2xl border border-white/10 bg-white/5 px-4 py-4 text-xs uppercase tracking-[0.28em] text-white/70">
          <input class="mt-1 h-4 w-4 accent-rose-gold" type="checkbox" name="consent" required />
          {t(lang, 'apply.fastlane.consent')}
        </label>
        <button
          data-claim-submit
          class="inline-flex items-center justify-center rounded-full border border-rose-gold/70 bg-rose-gold px-6 py-3 text-sm uppercase tracking-[0.3em] text-midnight shadow-glow transition hover:-translate-y-1"
          type="submit"
        >
          Submit application
        </button>
        <p class="hidden text-xs text-rose-petal" data-token-error role="alert">Please refresh and try again.</p>
      </section>

      <details class="rounded-2xl border border-white/10 bg-white/5 p-5 sm:col-span-2" data-optional-details data-apply-step="2">
        <summary class="cursor-pointer text-sm font-semibold uppercase tracking-[0.22em] text-rose-petal focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rose-gold">
          Improve my match (optional)
        </summary>
        <p class="mt-3 text-xs text-white/60">Optional details help us match you faster.</p>

        <div class="mt-5 grid gap-4 sm:grid-cols-2">
          <label class="flex flex-col gap-2 text-sm text-white/70">
            Email (optional)
            <input
              class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white"
              type="email"
              name="email"
              placeholder="you@domain.com"
              autocomplete="email"
            />
          </label>

          <label class="flex flex-col gap-2 text-sm text-white/70">
            WhatsApp (optional)
            <input
              class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white"
              type="text"
              name="whatsapp"
              placeholder="+1 555 000 0000"
              autocomplete="tel"
            />
          </label>

          <label class="flex flex-col gap-2 text-sm text-white/70">
            Timezone (optional)
            <select class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white" name="timezone">
              <option value="">Select timezone</option>
              {timezoneOptions.map((tz) => (
                <option value={tz}>{tz}</option>
              ))}
            </select>
          </label>
          <label class="flex flex-col gap-2 text-sm text-white/70">
            Preferred contact (optional)
            <div class="flex flex-wrap gap-3">
              {['telegram', 'email', 'whatsapp'].map((option) => (
                <label class="flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-2 text-xs uppercase tracking-[0.28em] text-white/70">
                  <input class="h-4 w-4 accent-rose-gold" type="radio" name="preferred_contact" value={option} />
                  {option}
                </label>
              ))}
            </div>
          </label>
        </div>

        <div class="mt-4 grid gap-4 sm:grid-cols-2" data-apply-step="3">
          <label class="flex flex-col gap-2 text-sm text-white/70">
            Typical start time (optional)
            <select class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white" name="time_start">
              <option value="">Start time</option>
              {timeOptions.map((time) => (
                <option value={time}>{time}</option>
              ))}
            </select>
          </label>
          <label class="flex flex-col gap-2 text-sm text-white/70">
            Typical end time (optional)
            <select class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white" name="time_end">
              <option value="">End time</option>
              {timeOptions.map((time) => (
                <option value={time}>{time}</option>
              ))}
            </select>
          </label>
        </div>

        <div class="mt-4 space-y-3" data-apply-step="3">
          <p class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">Typical streaming days (optional)</p>
          <div class="flex flex-wrap gap-3">
            {dayOptions.map((day) => (
              <label class="flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-2 text-xs uppercase tracking-[0.28em] text-white/70">
                <input class="h-4 w-4 accent-rose-gold" type="checkbox" name="days[]" value={day} />
                {day}
              </label>
            ))}
          </div>
        </div>

        <div class="mt-4 space-y-3" data-apply-step="3">
          <p class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">Already on (optional)</p>
          <div class="grid gap-2 sm:grid-cols-2">
            {PLATFORMS.map((platform) => (
              <label class="flex items-center gap-3 rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-sm text-white/70">
                <input
                  class="h-4 w-4 accent-rose-gold"
                  type="checkbox"
                  name="platforms_active[]"
                  value={platform.slug}
                />
                <span class="text-white">{platform.name}</span>
              </label>
            ))}
          </div>
        </div>

        <div class="mt-4 space-y-3" data-apply-step="3">
          <p class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">Content style (optional)</p>
          <div class="flex flex-wrap gap-3">
            {styleOptions.map((style) => (
              <label class="flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-2 text-xs uppercase tracking-[0.28em] text-white/70">
                <input class="h-4 w-4 accent-rose-gold" type="checkbox" name="style[]" value={style.value} />
                {style.label}
              </label>
            ))}
          </div>
        </div>

        <div class="mt-4 space-y-3" data-apply-step="3">
          <p class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">Hard no list (optional)</p>
          <div class="flex flex-wrap gap-3">
            {hardNoOptions.map((item) => (
              <label class="flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-2 text-xs uppercase tracking-[0.28em] text-white/70">
                <input class="h-4 w-4 accent-rose-gold" type="checkbox" name="hard_no[]" value={item.value} />
                {item.label}
              </label>
            ))}
          </div>
        </div>

        <div class="mt-4 grid gap-4 sm:grid-cols-2" data-apply-step="3">
          <label class="flex flex-col gap-2 text-sm text-white/70">
            Asset link (optional)
            <input
              class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white"
              type="url"
              name="asset_link"
              placeholder="https://"
              autocomplete="off"
            />
          </label>

          <label class="flex flex-col gap-2 text-sm text-white/70">
            Anything else? (optional)
            <textarea
              class="min-h-[120px] rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white"
              name="notes"
              placeholder="Share goals or boundaries."
            ></textarea>
          </label>
        </div>
      </details>

    </form>
  </section>
  <script is:inline define:vars={{ csrfEndpoint }}>
    {`(function () {
  const form = document.querySelector('form[action$=\"/claim/index.php\"]');
  const progressRoot = document.querySelector('[data-apply-progress]');
  const currentStepEl = progressRoot instanceof HTMLElement
    ? progressRoot.querySelector('[data-current-step]')
    : null;
  const progressFill = progressRoot instanceof HTMLElement
    ? progressRoot.querySelector('[data-progress-fill]')
    : null;
  const stepLabels = progressRoot instanceof HTMLElement
    ? Array.from(progressRoot.querySelectorAll('[data-step-label]'))
    : [];
  const optionalDetails = form instanceof HTMLFormElement
    ? form.querySelector('[data-optional-details]')
    : null;
  const setProgressStep = (value) => {
    const step = Math.max(1, Math.min(4, Number(value) || 1));
    if (currentStepEl instanceof HTMLElement) {
      currentStepEl.textContent = 'Step ' + step + ' of 4';
    }
    if (progressFill instanceof HTMLElement) {
      progressFill.style.width = String(step * 25) + '%';
    }
    stepLabels.forEach((label) => {
      if (!(label instanceof HTMLElement)) {
        return;
      }
      const labelStep = Number(label.getAttribute('data-step-label') || '0');
      const isActive = labelStep <= step;
      label.classList.toggle('border-rose-gold/50', isActive);
      label.classList.toggle('bg-rose-gold/20', isActive);
      label.classList.toggle('text-rose-petal', isActive);
      label.classList.toggle('border-white/10', !isActive);
      label.classList.toggle('bg-white/5', !isActive);
      label.classList.toggle('text-white/60', !isActive);
      if (labelStep === step) {
        label.setAttribute('aria-current', 'step');
      } else {
        label.removeAttribute('aria-current');
      }
    });
  };
  const resolveStepFromTarget = (target) => {
    if (!(target instanceof Element)) {
      return null;
    }
    const scopedStep = target.closest('[data-apply-step]');
    if (scopedStep instanceof HTMLElement) {
      const step = Number(scopedStep.getAttribute('data-apply-step') || '0');
      return step > 0 ? step : null;
    }
    if (target.closest('[data-claim-submit]')) {
      return 4;
    }
    return null;
  };

  setProgressStep(1);

  if (form instanceof HTMLFormElement) {
    const timezoneSelect = form.querySelector('select[name=\"timezone\"]');
    if (timezoneSelect instanceof HTMLSelectElement && !timezoneSelect.value) {
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
      if (tz.includes('Pacific')) timezoneSelect.value = 'PT';
      else if (tz.includes('Mountain')) timezoneSelect.value = 'MT';
      else if (tz.includes('Central')) timezoneSelect.value = 'CT';
      else if (tz.includes('Eastern')) timezoneSelect.value = 'ET';
      else if (tz.includes('Alaska')) timezoneSelect.value = 'AK';
      else if (tz.includes('Honolulu') || tz.includes('Hawaii')) timezoneSelect.value = 'HI';
      else if (tz.includes('UTC') || tz.includes('Etc/')) timezoneSelect.value = 'UTC';
    }

    form.addEventListener('focusin', (event) => {
      const step = resolveStepFromTarget(event.target);
      if (step) {
        setProgressStep(step);
      }
    });
    form.addEventListener('input', (event) => {
      const step = resolveStepFromTarget(event.target);
      if (step) {
        setProgressStep(step);
      }
    });
    form.addEventListener('submit', () => {
      setProgressStep(4);
    });
    const submitButton = form.querySelector('[data-claim-submit]');
    if (submitButton instanceof HTMLButtonElement) {
      submitButton.addEventListener('click', () => {
        setProgressStep(4);
      });
    }
    if (optionalDetails instanceof HTMLDetailsElement) {
      optionalDetails.addEventListener('toggle', () => {
        setProgressStep(optionalDetails.open ? 2 : 1);
      });
    }

  }

  const tokenInput = document.querySelector('[data-csrf-token]');
  const submitButtons = form instanceof HTMLFormElement
    ? Array.from(form.querySelectorAll('[data-claim-submit]'))
    : [];
  const tokenError = form instanceof HTMLFormElement
    ? form.querySelector('[data-token-error]')
    : null;

  if (!(tokenInput instanceof HTMLInputElement) || !csrfEndpoint || !(form instanceof HTMLFormElement)) {
    return;
  }

  submitButtons.forEach((button) => {
    if (button instanceof HTMLButtonElement) {
      button.disabled = true;
      button.setAttribute('aria-disabled', 'true');
    }
  });

  fetch(csrfEndpoint, {
    method: 'GET',
    credentials: 'same-origin',
    headers: { Accept: 'application/json' }
  })
    .then((response) => (response.ok ? response.json() : null))
    .then((data) => {
      if (!data || typeof data.token !== 'string' || data.token.trim() === '') {
        throw new Error('Missing token');
      }
      tokenInput.value = data.token;
      submitButtons.forEach((button) => {
        if (button instanceof HTMLButtonElement) {
          button.disabled = false;
          button.removeAttribute('aria-disabled');
        }
      });
      if (tokenError instanceof HTMLElement) {
        tokenError.classList.add('hidden');
      }
    })
    .catch(() => {
      submitButtons.forEach((button) => {
        if (button instanceof HTMLButtonElement) {
          button.disabled = true;
          button.setAttribute('aria-disabled', 'true');
        }
      });
      if (tokenError instanceof HTMLElement) {
        tokenError.classList.remove('hidden');
      }
    });
})();`}
  </script>
</MainLayout>
