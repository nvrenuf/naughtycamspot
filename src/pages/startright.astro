---
import LinkCTA from '../components/LinkCTA.astro';
import Notices from '../components/Notices.astro';
import PreClickCapture from '../components/PreClickCapture.astro';
import SEO from '../components/SEO.astro';
import MainLayout from '../layouts/MainLayout.astro';
import VipTeasers from '../components/VipTeasers.astro';
import { HERO, PRIMARY_CTA, STARTRIGHT_SKIP } from '../data/copy';
import { gearKits } from '../data/gear-kits';
import programs from '../data/programs.json';
import { resolveProgramDetail, type ResolvedProgramDetail } from '../data/programDetails';
import { resolveProgramStatusMeta, type ProgramStatus } from '../data/programStatus';
import { formatDateStamp } from '../utils/links';
import {
  buildPagesJoinHref,
  allowsPagesJoin,
  isProgramApproved,
  type ProgramRecord
} from '../utils/programs.js';

const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
const qs = `?src=${STARTRIGHT_SKIP.tracking.src}&camp=${STARTRIGHT_SKIP.tracking.camp}&date=${today}`;

type ProgramEntry = ProgramRecord & {
  key: string;
  type: string;
  status: ProgramStatus;
  join_base: string;
  subid_params: string[];
};

type EnrichedProgram = ProgramEntry & ResolvedProgramDetail;

const canonicalPath = '/startright';
const nameCheckPath = '/startright/name-check';

const dateStamp = formatDateStamp();
const skipHrefPages = `${STARTRIGHT_SKIP.pagesHrefBase}${qs}`;
const skipHrefProd = skipHrefPages;
const preclickGoLinks = ['/go/bonga', '/go/camsoda', '/go/chaturbate'];

const baseUrl = typeof import.meta.env.BASE_URL === 'string' ? import.meta.env.BASE_URL : '/';
const isPagesFlag = typeof import.meta.env.IS_PAGES === 'string' ? import.meta.env.IS_PAGES === 'true' : false;
const isPagesBuild = isPagesFlag || baseUrl !== '/';

const enrichedPrograms: EnrichedProgram[] = (programs as ProgramEntry[]).map((program) => ({
  ...program,
  ...resolveProgramDetail(program.key)
}));

const startRightGearHighlights = gearKits.map((kit) => ({
  id: kit.id,
  name: kit.name,
  investment: kit.investment,
  spotlight: kit.spotlight,
  highlights: kit.items.slice(0, 2).map((item) => ({
    name: item.name,
    description: item.description
  })),
  conciergeNote: kit.conciergeNote
}));

const desiredUsername = Astro.url.searchParams.get('desiredUsername');
const basePrograms = enrichedPrograms
  .filter((program) => isProgramApproved(program) && allowsPagesJoin(program))
  .map((program) => {
    const slot = `startright_${program.key}`;
    const joinHrefPages = buildPagesJoinHref(program, {
      slot,
      src: slot,
      camp: 'startright',
      date: dateStamp
    });
    const joinHrefProd = `/go/${program.key}`;
    const statusMeta = resolveProgramStatusMeta(program.status);
    const joinDisabled =
      !statusMeta.allowsJoin || !allowsPagesJoin(program) || !/^https?:\/\//i.test(joinHrefPages ?? '');

    return {
      ...program,
      joinHrefPages,
      joinHrefProd,
      joinHrefResolved: isPagesBuild ? joinHrefPages : joinHrefProd,
      joinDisabled,
      statusLabel: statusMeta.label,
      statusTextClass: statusMeta.textClass,
      statusDisclosure: statusMeta.disclosure,
      joinDisabledLabel: statusMeta.joinDisabledLabel,
      statusAllowsJoin: statusMeta.allowsJoin
    };
  });

const defaultAnswers = {
  experience: 'new',
  hours: 10,
  timezone: 'NA',
  language: 'EN',
  content: 'cam only',
  payout: 'ASAP',
  device: 'basic'
};

const fieldClass =
  'w-full rounded-full border border-white/15 bg-white/5 px-4 py-2 text-sm text-white/80 focus:border-rose-gold focus:outline-none focus:ring-2 focus:ring-rose-gold/40 backdrop-blur-xl';

type Answers = typeof defaultAnswers;

type Recommendation = (typeof basePrograms)[number] & {
  score: number;
  reasons: string[];
};

const ensureReasons = (rec: Recommendation) => {
  const baseReasons = rec.best_for.map((item, index) =>
    index === 0 ? `Strong fit for ${item}.` : `Also helps with ${item}.`
  );
  for (const reason of baseReasons) {
    if (!rec.reasons.includes(reason)) {
      rec.reasons.push(reason);
    }
  }
  if (rec.reasons.length < 2) {
    rec.reasons.push('StartRight kit unlock keeps resources flowing.');
  }
  return rec;
};

const evaluate = (answers: Answers) => {
  const entries: Recommendation[] = basePrograms.map((program) => ({
    ...program,
    score: 1,
    reasons: []
  }));
  const map = new Map(entries.map((item) => [item.key, item] as const));

  const addReason = (key: string, reason: string, weight = 1) => {
    const target = map.get(key);
    if (!target) return;
    target.score += weight;
    if (!target.reasons.includes(reason)) {
      target.reasons.push(reason);
    }
  };

  if (answers.experience === 'new' && answers.payout === 'ASAP') {
    addReason('camsoda', 'Fast weekly payouts keep new creators liquid.', 2);
    addReason('camsoda', 'Low-friction verification so you go live faster.', 1);
  }

  if (answers.timezone === 'NA') {
    addReason('chaturbate', 'Massive North America traffic for your schedule.', 1.5);
    addReason('chaturbate', 'Room categories stay busy 24/7 for EN-first creators.', 1);
  }

  if (answers.timezone === 'EU' || answers.timezone === 'LatAm') {
    addReason('bonga', 'Regional bounties reward EU / LatAm creators.', 1.5);
    addReason('bonga', 'Geo-weighted promos help you surface faster.', 1);
  }

  if (answers.content === 'cam + clips') {
    addReason('chaturbate', 'Clip-friendly ecosystem to diversify later.', 0.5);
  }

  if (answers.device === 'pro') {
    addReason('chaturbate', 'Pro setups shine on high-volume directories.', 0.5);
  }

  entries.forEach(ensureReasons);

  return entries
    .sort((a, b) => {
      if (b.score === a.score) {
        return a.name.localeCompare(b.name);
      }
      return b.score - a.score;
    })
    .slice(0, 3);
};

const defaultRecommendations = evaluate(defaultAnswers);
const clientPrograms = JSON.stringify(
  basePrograms.map((program) => ({
    key: program.key,
    name: program.name,
    joinHrefPages: program.joinHrefPages,
    joinHrefProd: program.joinHrefProd,
    joinDisabled: program.joinDisabled,
    joinDisabledLabel: program.joinDisabledLabel,
    best_for: program.best_for,
    status: program.status,
    statusLabel: program.statusLabel,
    statusTextClass: program.statusTextClass,
    statusDisclosure: program.statusDisclosure,
    statusAllowsJoin: program.statusAllowsJoin
  }))
);
---

<MainLayout
  title="StartRight for models | NaughtyCamSpot"
  description="Skip the guesswork. Pick the right platforms and get a tailored launch kit — free."
>
  <SEO
    slot="head"
    title="StartRight for models | NaughtyCamSpot"
    description="Skip the guesswork. Pick the right platforms and get a tailored launch kit — free."
    path={canonicalPath}
  />
  <PreClickCapture />
  <div class="hidden" data-preclick-go-links={preclickGoLinks.join(',')} aria-hidden="true"></div>
  <section class="space-y-8">
    <Notices />
    <div class="space-y-4">
      <h1 class="font-display text-4xl text-white sm:text-5xl">{HERO.title}</h1>
      <p class="max-w-3xl text-base text-white/70">{HERO.sub}</p>
      <p class="max-w-3xl text-base text-white/65">
        Tune the inputs to match your situation. We&apos;ll translate those signals into a ranked list of partner programs, share
        why they fit, and route you to the guarded links you need to unlock the StartRight launch kit.
      </p>
      <div class="flex flex-col gap-3 sm:flex-row sm:flex-wrap sm:items-center">
        <LinkCTA
          class="border border-rose-gold/60 bg-rose-gold text-midnight text-sm tracking-[0.2em] shadow-glow"
          pagesHref={PRIMARY_CTA.pagesHref}
          prodHref={PRIMARY_CTA.prodHref}
          label={PRIMARY_CTA.label}
        />
        <LinkCTA
          class="btn btn-secondary w-full sm:w-auto"
          pagesHref={skipHrefPages}
          prodHref={skipHrefProd}
          label={STARTRIGHT_SKIP.label}
        />
        <LinkCTA
          class="btn btn-secondary w-full sm:w-auto"
          pagesHref={nameCheckPath}
          prodHref={nameCheckPath}
          label="Step 2: Check Name Availability"
        />
      </div>
      {desiredUsername && (
        <div class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-500/10 px-4 py-2 text-sm text-emerald-100">
          <span class="text-xs uppercase tracking-[0.35em] text-emerald-200">Selected username</span>
          <span class="font-semibold text-white">{desiredUsername}</span>
        </div>
      )}
    </div>
    <form id="startright-form" class="grid gap-6 rounded-[32px] border border-white/10 bg-white/5 p-6 backdrop-blur-2xl">
      <div class="grid gap-4 sm:grid-cols-2">
        <label class="space-y-2 text-sm text-white/70">
          <span class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">Experience level</span>
          <select name="experience" class={fieldClass}>
            <option value="new" selected>new</option>
            <option value="intermediate">intermediate</option>
          </select>
        </label>
        <label class="space-y-2 text-sm text-white/70">
          <span class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">Hours per week</span>
          <input name="hours" type="number" min="1" value="10" class={fieldClass} />
        </label>
        <label class="space-y-2 text-sm text-white/70">
          <span class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">Timezone</span>
          <select name="timezone" class={fieldClass}>
            <option value="NA" selected>NA</option>
            <option value="EU">EU</option>
            <option value="LatAm">LatAm</option>
            <option value="APAC">APAC</option>
          </select>
        </label>
        <label class="space-y-2 text-sm text-white/70">
          <span class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">Primary language</span>
          <select name="language" class={fieldClass}>
            <option value="EN" selected>EN</option>
            <option value="ES">ES</option>
            <option value="PT">PT</option>
            <option value="RU">RU</option>
            <option value="Other">Other</option>
          </select>
        </label>
        <label class="space-y-2 text-sm text-white/70">
          <span class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">Content mix</span>
          <select name="content" class={fieldClass}>
            <option value="cam only" selected>cam only</option>
            <option value="cam + clips">cam + clips</option>
          </select>
        </label>
        <label class="space-y-2 text-sm text-white/70">
          <span class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">Payout urgency</span>
          <select name="payout" class={fieldClass}>
            <option value="ASAP" selected>ASAP</option>
            <option value="flexible">flexible</option>
          </select>
        </label>
        <label class="space-y-2 text-sm text-white/70">
          <span class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">Device / gear setup</span>
          <select name="device" class={fieldClass}>
            <option value="basic" selected>basic</option>
            <option value="mid">mid</option>
            <option value="pro">pro</option>
          </select>
        </label>
      </div>
    </form>
    <section
      class="space-y-6 rounded-[32px] border border-white/10 bg-white/5 p-6 backdrop-blur-2xl"
      id="startright-results"
      data-programs={clientPrograms}
      data-is-pages={import.meta.env.IS_PAGES === 'true' ? 'true' : 'false'}
      data-primary-label={PRIMARY_CTA.label}
      data-primary-pages={PRIMARY_CTA.pagesHref}
      data-primary-prod={PRIMARY_CTA.prodHref}
      data-skip-label={STARTRIGHT_SKIP.label}
      data-skip-pages={skipHrefPages}
      data-skip-prod={skipHrefProd}
    >
      <div class="space-y-2">
        <h2 class="font-display text-3xl text-white">Your best starting points</h2>
        <p class="text-sm text-white/60">Switch the form inputs to refresh this guidance. We pick the top three matches.</p>
      </div>
      <div class="space-y-5" id="startright-list">
        {defaultRecommendations.map((result) => (
          <article class="rounded-3xl border border-white/10 bg-black/30 p-5">
            <header class="flex flex-wrap items-center justify-between gap-3">
              <div>
                <h3 class="font-display text-2xl text-white">{result.name}</h3>
                {!result.statusAllowsJoin && (
                  <p class={`text-xs uppercase tracking-[0.35em] ${result.statusTextClass}`}>
                    {result.statusLabel}
                  </p>
                )}
              </div>
              <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:gap-4">
                <div class="flex flex-col gap-2 sm:flex-row sm:items-start">
                  {result.joinDisabled ? (
                    <span class="inline-flex items-center justify-center rounded-full border border-white/15 bg-white/5 px-6 py-3 text-xs uppercase tracking-[0.3em] text-white/40">
                      {result.joinDisabledLabel}
                    </span>
                  ) : (
                    <a
                      class="inline-flex items-center justify-center rounded-full border border-rose-gold/60 bg-rose-gold px-6 py-3 text-xs font-semibold uppercase tracking-[0.3em] text-midnight shadow-glow transition hover:-translate-y-1"
                      href={result.joinHrefResolved}
                      target="_blank"
                      rel="noopener"
                      data-preclick-trigger="true"
                      data-go-href={result.joinHrefResolved}
                      data-platform-id={result.key}
                      data-platform-name={result.name}
                    >
                      Join with our links
                    </a>
                  )}
                </div>
                <div class="flex flex-col gap-2 sm:items-start">
                  <LinkCTA
                    class="border border-white/20 bg-transparent text-white hover:bg-white/10"
                    pagesHref={PRIMARY_CTA.pagesHref}
                    prodHref={PRIMARY_CTA.prodHref}
                    label={PRIMARY_CTA.label}
                  />
                  <LinkCTA
                    class="border border-white/15 bg-transparent text-white/70 hover:border-white/30 hover:bg-white/10 hover:text-white"
                    pagesHref={skipHrefPages}
                    prodHref={skipHrefProd}
                    label={STARTRIGHT_SKIP.label}
                  />
                </div>
              </div>
            </header>
            <ul class="mt-4 space-y-2 text-sm text-white/70">
              {result.reasons.slice(0, 2).map((reason) => (
                <li class="flex items-start gap-2">
                  <span aria-hidden="true" class="mt-1 h-1.5 w-1.5 rounded-full bg-rose-gold"></span>
                  <span>{reason}</span>
                </li>
              ))}
            </ul>
          </article>
        ))}
      </div>
      <p class="text-xs uppercase tracking-[0.3em] text-white/45">
        This is guidance, not a guarantee. Use our links → unlock your StartRight plan.
      </p>
    </section>
  </section>
  <VipTeasers />
  <section class="content-card space-y-6">
    <div class="space-y-3">
      <h2 class="section-heading">StartRight gear concierge</h2>
      <p class="max-w-3xl text-sm text-white/70">
        We tailor your setup alongside the platform plan so lighting, audio, and automation all match the rituals inside your
        StartRight kit. These are the builds we deploy most often for new concierge clients.
      </p>
    </div>
    <div class="grid gap-6 lg:grid-cols-3">
      {startRightGearHighlights.map((kit) => (
        <article class="flex h-full flex-col gap-4 rounded-[28px] border border-white/10 bg-white/5 p-5 backdrop-blur-2xl">
          <header class="space-y-2">
            <h3 class="font-display text-xl text-white">{kit.name}</h3>
            <p class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">{kit.investment}</p>
          </header>
          <p class="text-sm text-white/70">{kit.spotlight}</p>
          <ul class="space-y-2 text-sm text-white/70">
            {kit.highlights.map((item) => (
              <li class="flex items-start gap-2">
                <span aria-hidden="true" class="mt-1 h-1.5 w-1.5 rounded-full bg-rose-gold"></span>
                <span>
                  <span class="font-semibold text-white">{item.name}</span> — {item.description}
                </span>
              </li>
            ))}
          </ul>
          {kit.conciergeNote && <p class="text-xs text-white/50">{kit.conciergeNote}</p>}
        </article>
      ))}
    </div>
    <p class="text-sm text-white/60">
      Need the full breakdown? Email <a class="text-rose-gold underline decoration-rose-gold/60 decoration-2 underline-offset-4" href="mailto:concierge@naughtycamspot.com">concierge@naughtycamspot.com</a>
      for wiring diagrams and procurement help.
    </p>
  </section>
  <script is:inline>
    const form = document.querySelector('#startright-form');
    const resultsContainer = document.querySelector('#startright-results');
    const list = document.querySelector('#startright-list');
    if (form && resultsContainer && list) {
      const rawPrograms = JSON.parse(resultsContainer.dataset.programs || '[]');
    const programs = rawPrograms.map((program) => ({
      ...program,
      joinDisabled: program.joinDisabled === true,
      joinDisabledLabel: program.joinDisabledLabel || 'Join path pending',
      statusLabel: program.statusLabel || 'Pending',
      statusTextClass: program.statusTextClass || 'text-amber-200',
      statusAllowsJoin: program.statusAllowsJoin === true,
      statusDisclosure: program.statusDisclosure || 'Awaiting final affiliate paperwork.'
    }));
      const isPagesBuild = resultsContainer.dataset.isPages === 'true';
      const primaryLabel = resultsContainer.dataset.primaryLabel || 'Get my plan';
      const primaryPages = resultsContainer.dataset.primaryPages || ${JSON.stringify(canonicalPath)};
      const primaryProd = resultsContainer.dataset.primaryProd || ${JSON.stringify(canonicalPath)};
      const skipLabel = resultsContainer.dataset.skipLabel || 'Skip — pick my platforms';
      const skipPages = resultsContainer.dataset.skipPages || ${JSON.stringify(canonicalPath)};
      const skipProd = resultsContainer.dataset.skipProd || ${JSON.stringify(canonicalPath)};
      const formatDateStamp = () => {
        const now = new Date();
        return `${now.getUTCFullYear()}${String(now.getUTCMonth() + 1).padStart(2, '0')}${String(now.getUTCDate()).padStart(2, '0')}`;
      };
      const searchParams = new URLSearchParams(window.location.search);
      const inboundSrc = searchParams.get('src') || '';
      const inboundCamp = searchParams.get('camp') || '';
      const inboundDate = searchParams.get('date') || '';
      const computeTracking = (defaults) => {
        const date = defaults.date || formatDateStamp();
        return {
          src: inboundSrc || defaults.src,
          camp: inboundCamp || defaults.camp,
          date: inboundDate || date,
          slot: defaults.slot
        };
      };
      const applyTrackingToPath = (href, defaults) => {
        if (!href || /^https?:\/\//i.test(href)) {
          return href;
        }
        try {
          const url = new URL(href, window.location.origin);
          const tracking = computeTracking(defaults);
          if (tracking.src) url.searchParams.set('src', tracking.src);
          if (tracking.camp) url.searchParams.set('camp', tracking.camp);
          if (tracking.date) url.searchParams.set('date', tracking.date);
          if (tracking.slot) url.searchParams.set('slot', tracking.slot);
          return `${url.pathname}${url.search}${url.hash}`;
        } catch (error) {
          return href;
        }
      };
      const ensureReasons = (rec) => {
        const baseReasons = (rec.best_for || []).map((item, index) =>
          index === 0 ? `Strong fit for ${item}.` : `Also helps with ${item}.`
        );
        baseReasons.forEach((reason) => {
          if (!rec.reasons.includes(reason)) {
            rec.reasons.push(reason);
          }
        });
        if (rec.reasons.length < 2) {
          rec.reasons.push('StartRight kit unlock keeps resources flowing.');
        }
        return rec;
      };
      const evaluate = (answers) => {
        const items = programs.map((program) => ({
          ...program,
          score: 1,
          reasons: []
        }));
        const map = new Map(items.map((item) => [item.key, item]));
        const addReason = (key, reason, weight = 1) => {
          const target = map.get(key);
          if (!target) return;
          target.score += weight;
          if (!target.reasons.includes(reason)) {
            target.reasons.push(reason);
          }
        };
        if (answers.experience === 'new' && answers.payout === 'ASAP') {
          addReason('camsoda', 'Fast weekly payouts keep new creators liquid.', 2);
          addReason('camsoda', 'Low-friction verification so you go live faster.', 1);
        }
        if (answers.timezone === 'NA') {
          addReason('chaturbate', 'Massive North America traffic for your schedule.', 1.5);
          addReason('chaturbate', 'Room categories stay busy 24/7 for EN-first creators.', 1);
        }
        if (answers.timezone === 'EU' || answers.timezone === 'LatAm') {
          addReason('bonga', 'Regional bounties reward EU / LatAm creators.', 1.5);
          addReason('bonga', 'Geo-weighted promos help you surface faster.', 1);
        }
        if (answers.content === 'cam + clips') {
          addReason('chaturbate', 'Clip-friendly ecosystem to diversify later.', 0.5);
        }
        if (answers.device === 'pro') {
          addReason('chaturbate', 'Pro setups shine on high-volume directories.', 0.5);
        }
        items.forEach(ensureReasons);
        return items
          .sort((a, b) => {
            if (b.score === a.score) {
              return a.name.localeCompare(b.name);
            }
            return b.score - a.score;
          })
          .slice(0, 3);
      };
      const trackEvent = (name, payload) => {
        if (typeof window !== 'undefined' && typeof window.gtag === 'function') {
          window.gtag('event', name, payload);
        }
      };
      const getEventBase = () => ({
        src: inboundSrc || 'startright',
        camp: inboundCamp || 'startright',
        date: inboundDate || formatDateStamp()
      });
      trackEvent('startright_open', getEventBase());
      let lastResultSignature = '';
      const render = (recommendations) => {
        const primaryDefaults = {
          src: 'startright_plan',
          camp: 'startright',
          date: formatDateStamp(),
          slot: 'startright_plan'
        };
        const primaryHref = isPagesBuild ? primaryPages : applyTrackingToPath(primaryProd, primaryDefaults);
        const primaryIsExternal = /^https?:\/\//i.test(primaryHref);
        const primaryTarget = primaryIsExternal ? '_blank' : '_self';
        const primaryRel = primaryIsExternal ? 'nofollow noopener' : '';
        const primaryButton = `<a class="inline-flex items-center justify-center rounded-full border border-white/20 bg-transparent px-6 py-3 text-xs font-semibold uppercase tracking-[0.3em] text-white transition hover:-translate-y-1 hover:bg-white/10" href="${primaryHref}" target="${primaryTarget}"${primaryRel ? ` rel="${primaryRel}"` : ''}>${primaryLabel}${primaryIsExternal ? '<span class="ml-2" aria-hidden="true">↗</span>' : ''}</a>`;
        list.innerHTML = recommendations
          .map((result) => {
            const reasons = result.reasons.slice(0, 2)
              .map((reason) => `<li class="flex items-start gap-2"><span aria-hidden="true" class="mt-1 h-1.5 w-1.5 rounded-full bg-rose-gold"></span><span>${reason}</span></li>`)
              .join('');
            const joinHrefPages = result.joinHrefPages;
            const joinHrefProd = result.joinHrefProd;
            const resolvedJoinHref = isPagesBuild ? joinHrefPages : joinHrefProd;
            const joinDisabled =
              result.joinDisabled ||
              !result.statusAllowsJoin ||
              (isPagesBuild ? !/^https?:\/\//i.test(joinHrefPages || '') : !resolvedJoinHref);
            const joinLabel = 'Join with our links';
            const joinIsExternal = /^https?:\/\//i.test(resolvedJoinHref);
            const joinRel = joinIsExternal ? 'nofollow noopener' : 'noopener';
            const joinDisabledLabel = result.joinDisabledLabel || 'Join path pending';
            const joinButton = joinDisabled
              ? `<span class="inline-flex items-center justify-center rounded-full border border-white/15 bg-white/5 px-6 py-3 text-xs uppercase tracking-[0.3em] text-white/40" aria-disabled="true">${joinDisabledLabel}</span>`
              : `<a class="inline-flex items-center justify-center rounded-full border border-rose-gold/60 bg-rose-gold px-6 py-3 text-xs font-semibold uppercase tracking-[0.3em] text-midnight shadow-glow transition hover:-translate-y-1" href="${resolvedJoinHref}" target="_blank" rel="${joinRel}" data-preclick-trigger="true" data-go-href="${resolvedJoinHref}" data-platform-id="${result.key}" data-platform-name="${result.name}">${joinLabel}${joinIsExternal ? '<span class="ml-2" aria-hidden="true">↗</span>' : ''}</a>`;
            const primaryHref = isPagesBuild ? primaryPages : primaryProd;
            const primaryIsExternal = /^https?:\/\//i.test(primaryHref);
            const primaryTarget = primaryIsExternal ? '_blank' : '_self';
            const primaryRel = primaryIsExternal ? 'nofollow noopener' : '';
            const primaryButton = `<a class="inline-flex items-center justify-center rounded-full border border-white/20 bg-transparent px-6 py-3 text-xs font-semibold uppercase tracking-[0.3em] text-white transition hover:-translate-y-1 hover:bg-white/10" href="${primaryHref}" target="${primaryTarget}"${primaryRel ? ` rel="${primaryRel}"` : ''}>${primaryLabel}${primaryIsExternal ? '<span class="ml-2" aria-hidden="true">↗</span>' : ''}</a>`;
            const skipHref = isPagesBuild ? skipPages : skipProd;
            const skipIsExternal = /^https?:\/\//i.test(skipHref);
            const skipTarget = skipIsExternal ? '_blank' : '_self';
            const skipRel = skipIsExternal ? 'nofollow noopener' : '';
            const skipButton = `<a class="inline-flex items-center justify-center rounded-full border border-white/15 bg-transparent px-6 py-3 text-xs font-semibold uppercase tracking-[0.3em] text-white/70 transition hover:-translate-y-1 hover:border-white/30 hover:bg-white/10 hover:text-white" href="${skipHref}" target="${skipTarget}"${skipRel ? ` rel="${skipRel}"` : ''}>${skipLabel}${skipIsExternal ? '<span class="ml-2" aria-hidden="true">↗</span>' : ''}</a>`;
            const statusLabel = !result.statusAllowsJoin
              ? `<p class="text-xs uppercase tracking-[0.35em] ${result.statusTextClass || 'text-amber-200'}">${result.statusLabel || 'Pending'}</p>`
              : '';
            return `<article class="rounded-3xl border border-white/10 bg-black/30 p-5"><header class="flex flex-wrap items-center justify-between gap-3"><div><h3 class="font-display text-2xl text-white">${result.name}</h3>${statusLabel}</div><div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:gap-4"><div class="flex flex-col gap-2 sm:flex-row sm:items-start">${joinButton}</div><div class="flex flex-col gap-2 sm:items-start">${primaryButton}${skipButton}</div></div></header><ul class="mt-4 space-y-2 text-sm text-white/70">${reasons}</ul></article>`;
          })
          .join('');
      };
      const collect = () => {
        const formData = new FormData(form);
        return {
          experience: formData.get('experience') || 'new',
          hours: Number(formData.get('hours') || 10),
          timezone: formData.get('timezone') || 'NA',
          language: formData.get('language') || 'EN',
          content: formData.get('content') || 'cam only',
          payout: formData.get('payout') || 'ASAP',
          device: formData.get('device') || 'basic'
        };
      };
      const update = ({ emitSubmit = false } = {}) => {
        const answers = collect();
        const results = evaluate(answers);
        render(results);
        const signature = results
          .map((item) => `${item.key}:${item.score.toFixed(3)}`)
          .join('|');
        if (signature !== lastResultSignature) {
          lastResultSignature = signature;
          trackEvent('startright_result_view', {
            ...getEventBase(),
            top_keys: results.map((item) => item.key).join('|'),
            experience: answers.experience,
            timezone: answers.timezone,
            content: answers.content,
            payout: answers.payout,
            device: answers.device
          });
        }
        if (emitSubmit) {
          trackEvent('startright_submit', {
            ...getEventBase(),
            experience: answers.experience,
            timezone: answers.timezone,
            content: answers.content,
            payout: answers.payout,
            device: answers.device
          });
        }
      };
      update();
      form.addEventListener('input', () => update());
      form.addEventListener('change', () => update({ emitSubmit: true }));
    }
  </script>
</MainLayout>
