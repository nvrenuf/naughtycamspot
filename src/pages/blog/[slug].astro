---
import { getCollection } from 'astro:content';
import BannerSlot from '../../components/BannerSlot.astro';
import LinkCTA from '../../components/LinkCTA.astro';
import MainLayout from '../../layouts/MainLayout.astro';
import { PRIMARY_CTA } from '../../data/copy';
import { formatDateStamp, withBase } from '../../utils/links';

const formatDate = (date: Date) =>
  new Intl.DateTimeFormat('en-US', { month: 'long', day: '2-digit', year: 'numeric' }).format(date);

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const sorted = posts
    .filter((entry) => !entry.data.vipOnly)
    .slice()
    .sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime());

  return sorted.map((entry) => ({
    params: { slug: entry.slug },
    props: {
      post: entry,
      related: sorted.filter((item) => item.slug !== entry.slug).slice(0, 3)
    }
  }));
}

const { post, related } = Astro.props;
const { Content } = await post.render();

const firstParagraph =
  post.body
    .split(/\n\s*\n/)
    .map((block) => block.trim())
    .find((block) => block && !block.startsWith('#')) ?? post.data.description ?? '';

const isPages = import.meta.env.IS_PAGES === 'true';
const trackingQuery = new URLSearchParams({
  src: `blog_${post.slug}`,
  camp: 'post',
  date: formatDateStamp()
}).toString();

const buildTrackedHref = (baseHref?: string) => {
  const trimmed = typeof baseHref === 'string' ? baseHref.trim() : '';
  const fallback = '/startright';
  const target = trimmed.length > 0 ? trimmed : fallback;
  if (!trackingQuery) {
    return target;
  }
  const glue = target.includes('?') ? '&' : '?';
  return `${target}${glue}${trackingQuery}`;
};

const joinHrefPages = buildTrackedHref(PRIMARY_CTA.pagesHref);
const joinHrefProd = buildTrackedHref(PRIMARY_CTA.prodHref);
const joinCtaLabel = 'Open my StartRight plan';
const startRightMessage = isPages
  ? 'Pages builds route through the StartRight concierge hub with post-level tracking.'
  : 'Production routes directly to the on-site StartRight plan with post-level tracking.';
---

<MainLayout
  title={`${post.data.title} | NaughtyCamSpot Journal`}
  description={post.data.description}
>
  <!-- SECTION: Hero -->
  <article class="space-y-10">
    <header class="hero-shell parallax-veil">
      <div class="pointer-events-none absolute inset-0 bg-gradient-to-b from-black/60 via-transparent to-black/70"></div>
      <div class="relative space-y-4">
        <span class="hero-tagline">{post.data.category}</span>
        <h1 class="font-display text-5xl text-white sm:text-6xl">{post.data.title}</h1>
        <div class="flex flex-wrap items-center gap-4 text-xs uppercase tracking-[0.3em] text-white/60">
          <span>By {post.data.author}</span>
          <span>{formatDate(post.data.publishDate)}</span>
        </div>
      </div>
    </header>

    <div class="glass overflow-hidden rounded-[42px]">
      <img src={post.data.heroImage} alt={post.data.heroImageAlt ?? post.data.title} class="h-80 w-full object-cover" loading="lazy" />
    </div>

    {firstParagraph && (
      <div class="space-y-6 text-base leading-relaxed text-white/70">
        <p>{firstParagraph}</p>
        <div class="mt-6">
          <BannerSlot id="blog_inline_rect" class="w-full" placement={`blog-inline-${post.slug}`} />
        </div>
      </div>
    )}

    <div class="article-body space-y-6 text-base leading-relaxed text-white/70">
      <Content />
    </div>

    <div class="content-card space-y-5">
      <h2 class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">Continue your launch</h2>
      <div class="flex flex-col gap-3 sm:flex-row">
        <LinkCTA
          class="inline-flex items-center justify-center gap-2 border border-rose-gold/60 bg-rose-gold px-6 py-3 text-xs font-semibold uppercase tracking-[0.3em] text-midnight shadow-glow"
          pagesHref={joinHrefPages}
          prodHref={joinHrefProd}
        >
          {joinCtaLabel}
        </LinkCTA>
        <LinkCTA
          class="border border-white/20 bg-transparent text-white hover:bg-white/10"
          pagesHref={PRIMARY_CTA.pagesHref}
          prodHref={PRIMARY_CTA.prodHref}
          label={PRIMARY_CTA.label}
        />
      </div>
      <p class="text-xs text-white/50">{startRightMessage}</p>
    </div>
  </article>

  <!-- SECTION: Related Posts -->
  <section class="space-y-6">
    <h2 class="section-heading">Related Posts</h2>
    <div class="grid gap-6 sm:grid-cols-3">
      {related.map((item) => (
        <a class="content-card space-y-3" href={withBase(`/blog/${item.slug}`)}>
          <img src={item.data.cardImage ?? item.data.heroImage} alt={item.data.heroImageAlt ?? item.data.title} class="h-40 w-full rounded-3xl object-cover" loading="lazy" />
          <div>
            <p class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">{item.data.category}</p>
            <p class="font-display text-xl text-white">{item.data.title}</p>
            <p class="mt-1 text-xs uppercase tracking-[0.3em] text-white/40">{formatDate(item.data.publishDate)}</p>
          </div>
        </a>
      ))}
    </div>
  </section>

  <style>
    .article-body > p:first-of-type {
      display: none;
    }
  </style>
</MainLayout>
