---
import { getCollection } from 'astro:content';
import BannerSlot from '../../components/BannerSlot.astro';
import MainLayout from '../../layouts/MainLayout.astro';
import SEO from '../../components/SEO.astro';
import { withBase } from '../../utils/links';

const formatDate = (date: Date) =>
  new Intl.DateTimeFormat('en-US', { month: 'long', day: '2-digit', year: 'numeric' }).format(date);

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const sorted = posts
    .filter((entry) => !entry.data.vipOnly)
    .slice()
    .sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime());

  return sorted.map((entry) => ({
    params: { slug: entry.slug },
    props: {
      post: entry,
      related: sorted.filter((item) => item.slug !== entry.slug).slice(0, 3)
    }
  }));
}

const { post, related } = Astro.props;
const { Content } = await post.render();
const canonicalPath = `/posts/${post.slug}`;

const suppressCtas = post.data.suppressCtas || post.slug === 'thanksgiving-week-strategy';
---

<MainLayout
  title={`${post.data.title} | NaughtyCamSpot Journal`}
  description={post.data.description}
>
  <SEO
    slot="head"
    title={`${post.data.title} | NaughtyCamSpot Journal`}
    description={post.data.description}
    path={canonicalPath}
    ogImage={post.data.cardImage ?? post.data.heroImage}
    ogType="article"
  />

  <!-- SECTION: Hero -->
  <article class="space-y-10">
    <header class="hero-shell parallax-veil">
      <div class="pointer-events-none absolute inset-0 bg-gradient-to-b from-black/60 via-transparent to-black/70"></div>
      <div class="relative space-y-4">
        <span class="hero-tagline">{post.data.category}</span>
        <h1 class="font-display text-5xl text-white sm:text-6xl">{post.data.title}</h1>
        <div class="flex flex-wrap items-center gap-4 text-xs uppercase tracking-[0.3em] text-white/60">
          <span>By {post.data.author}</span>
          <span>{formatDate(post.data.publishDate)}</span>
        </div>
      </div>
    </header>

    <div class="glass overflow-hidden rounded-[42px]">
      <img src={post.data.heroImage} alt={post.data.heroImageAlt ?? post.data.title} class="h-80 w-full object-cover" loading="lazy" />
    </div>

    <div class="space-y-6 text-base leading-relaxed text-white/70">
      <Content />
    </div>

    {!suppressCtas && (
      <>
        <!-- SLOT: post_inline_rect -->
        <BannerSlot id="post_inline_rect" class="mt-6" showNote />
      </>
    )}
  </article>

  {!suppressCtas && (
    <>
      <!-- SLOT: post_end_strip -->
      <BannerSlot id="post_end_strip" class="mt-16" showNote />
    </>
  )}

  <!-- SECTION: Related Posts -->
  <section class="space-y-6">
    <h2 class="section-heading">Related Posts</h2>
    <div class="grid gap-6 sm:grid-cols-3">
      {related.map((item) => (
        <a class="content-card space-y-3" href={withBase(`/posts/${item.slug}`)}>
          <img src={item.data.cardImage ?? item.data.heroImage} alt={item.data.heroImageAlt ?? item.data.title} class="h-40 w-full rounded-3xl object-cover" loading="lazy" />
          <div>
            <p class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">{item.data.category}</p>
            <p class="font-display text-xl text-white">{item.data.title}</p>
            <p class="mt-1 text-xs uppercase tracking-[0.3em] text-white/40">{formatDate(item.data.publishDate)}</p>
          </div>
        </a>
      ))}
    </div>
  </section>
</MainLayout>
