---
import { getCollection } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';
import TrainingAccess from '../../components/TrainingAccess.astro';
import { withBase } from '../../utils/links';

const formatDate = (date: Date) =>
  new Intl.DateTimeFormat('en-US', { month: 'long', day: '2-digit', year: 'numeric' }).format(date);

export async function getStaticPaths() {
  const posts = await getCollection('training');
  const sorted = posts.slice().sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime());

  return sorted.map((entry) => ({
    params: { slug: entry.slug },
    props: {
      post: entry,
      related: sorted.filter((item) => item.slug !== entry.slug).slice(0, 3)
    }
  }));
}

const { post, related } = Astro.props;
const { Content } = await post.render();
const accessHash =
  typeof import.meta.env.PUBLIC_TRAINING_ACCESS_HASH === 'string'
    ? import.meta.env.PUBLIC_TRAINING_ACCESS_HASH.trim()
    : '';
const formattedDate = formatDate(post.data.publishDate);
---

<MainLayout
  title={`${post.data.title} | Training Vault`}
  description={post.data.description}
>
  <article class="space-y-8">
    <header class="hero-shell parallax-veil">
      <div class="pointer-events-none absolute inset-0 bg-gradient-to-b from-black/60 via-transparent to-black/70"></div>
      <div class="relative space-y-4">
        <span class="hero-tagline">{post.data.category}</span>
        <h1 class="font-display text-5xl text-white sm:text-6xl">{post.data.title}</h1>
        <div class="flex flex-wrap items-center gap-4 text-xs uppercase tracking-[0.3em] text-white/60">
          <span>By {post.data.author}</span>
          <span>{formattedDate}</span>
        </div>
      </div>
    </header>
  </article>

  <TrainingAccess
    accessHash={accessHash}
    title="Unlock VIP brief"
    description="Confirm your concierge code to view the full training breakdown."
    buttonLabel="Reveal brief"
    successMessage="Unlocked. Review the concierge notes below."
  >
    <article class="space-y-10">
      <div class="glass overflow-hidden rounded-[42px]">
        <img src={post.data.heroImage} alt={post.data.heroImageAlt ?? post.data.title} class="h-80 w-full object-cover" loading="lazy" />
      </div>
      <div class="space-y-6 text-base leading-relaxed text-white/70">
        <Content />
      </div>
    </article>

    {related.length > 0 && (
      <section class="space-y-6">
        <h2 class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">Related VIP briefs</h2>
        <div class="grid gap-6 sm:grid-cols-3">
          {related.map((item) => (
            <a class="content-card space-y-3" href={withBase(`/training/${item.slug}`)}>
              <img
                src={item.data.cardImage ?? item.data.heroImage}
                alt={item.data.heroImageAlt ?? item.data.title}
                class="h-40 w-full rounded-3xl object-cover"
                loading="lazy"
              />
              <div class="space-y-1">
                <p class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">{item.data.category}</p>
                <p class="font-display text-xl text-white">{item.data.title}</p>
                <p class="text-xs uppercase tracking-[0.3em] text-white/40">{formatDate(item.data.publishDate)}</p>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}
  </TrainingAccess>

  <p class="mt-12 text-xs uppercase tracking-[0.35em] text-white/50">
    <a class="transition hover:text-rose-petal" href={withBase('/training')}>
      ‚Üê Back to training index
    </a>
  </p>
</MainLayout>
