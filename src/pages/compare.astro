---
import LinkCTA from '../components/LinkCTA.astro';
import Notices from '../components/Notices.astro';
import MainLayout from '../layouts/MainLayout.astro';
import { PRIMARY_CTA } from '../data/copy';
import programs from '../data/programs.json';
import { resolveProgramStatusMeta, type ProgramStatus } from '../data/programStatus';

interface Program {
  key: string;
  name: string;
  join_base: string;
  subid_params: string[];
  payout: string;
  kyc: string;
  traffic: string;
  geo: string;
  best_for: string[];
  status: ProgramStatus;
}

type ProgramCard = Program & {
  joinHrefPages: string;
  joinHrefProd: string;
  joinDisabled: boolean;
  subidLine: string;
  statusLabel: string;
  statusBadgeClass: string;
  statusDisclosure: string;
  joinDisabledLabel: string;
};

const formatDateStamp = () => {
  const now = new Date();
  const year = String(now.getUTCFullYear());
  const month = String(now.getUTCMonth() + 1).padStart(2, '0');
  const day = String(now.getUTCDate()).padStart(2, '0');
  return `${year}${month}${day}`;
};

const dateStamp = formatDateStamp();
const programCards: ProgramCard[] = (programs as Program[]).map((program) => {
  const joinHrefProd = `/go/model-join.php?src=compare_${program.key}&camp=compare&date=${dateStamp}`;
  const joinHrefPages = program.join_base;
  const statusMeta = resolveProgramStatusMeta(program.status);
  const joinDisabled =
    !statusMeta.allowsJoin || !/^https?:\/\//i.test(joinHrefPages ?? '');

  return {
    ...program,
    joinHrefPages,
    joinHrefProd,
    joinDisabled,
    subidLine: program.subid_params.length > 0 ? `SubID params: ${program.subid_params.join(', ')}` : 'No subID params yet.',
    statusLabel: statusMeta.label,
    statusBadgeClass: statusMeta.badgeClass,
    statusDisclosure: statusMeta.disclosure,
    joinDisabledLabel: statusMeta.joinDisabledLabel
  };
});
---

<MainLayout title="Compare cam platforms" description="Compare cam platforms tailored for new creators launching with NaughtyCamSpot.">
  <section class="space-y-8">
    <Notices />
    <div class="space-y-4">
      <h1 class="font-display text-4xl text-white sm:text-5xl">Compare cam platforms for new creators</h1>
      <p class="max-w-3xl text-base text-white/70">
        These quick-reference cards show our current onboarding guardrails. Use them to decide where to launch, then join via the
        guarded links so we can ship your StartRight kit.
      </p>
    </div>
    <div class="grid gap-8 lg:grid-cols-3">
      {programCards.map((program) => (
        <article class="flex h-full flex-col gap-6 rounded-[32px] border border-white/10 bg-white/5 p-6 backdrop-blur-2xl">
          <header class="space-y-3">
            <div class="flex items-center justify-between gap-3">
              <h2 class="font-display text-2xl text-white">{program.name}</h2>
              <span
                class={`rounded-full px-3 py-1 text-[0.55rem] uppercase tracking-[0.3em] ${program.statusBadgeClass}`}
              >
                {program.statusLabel}
              </span>
            </div>
            <div class="flex flex-wrap gap-2 text-[0.65rem] uppercase tracking-[0.3em] text-white/60">
              <span class="rounded-full border border-white/15 px-3 py-1">Payout: {program.payout}</span>
              <span class="rounded-full border border-white/15 px-3 py-1">KYC: {program.kyc}</span>
              <span class="rounded-full border border-white/15 px-3 py-1">Traffic: {program.traffic}</span>
            </div>
          </header>
          <div class="space-y-4 text-sm text-white/70">
            <div>
              <p class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">Best for</p>
              <ul class="mt-2 space-y-1 list-disc pl-5">
                {program.best_for.map((item) => (
                  <li>{item}</li>
                ))}
              </ul>
            </div>
            <div>
              <p class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">GEO notes</p>
              <p>{program.geo}</p>
            </div>
          </div>
          <footer class="mt-auto space-y-4 text-xs text-white/50">
            <div class="flex flex-col gap-3 sm:flex-row">
              {program.joinDisabled ? (
                <span class="inline-flex items-center justify-center rounded-full border border-white/15 bg-white/5 px-6 py-3 text-xs uppercase tracking-[0.3em] text-white/40">
                  {program.joinDisabledLabel}
                </span>
              ) : (
                <LinkCTA
                  class="border border-rose-gold/60 bg-rose-gold text-midnight"
                  pagesHref={program.joinHrefPages}
                  prodHref={program.joinHrefProd}
                  label="Join with our links"
                />
              )}
              <LinkCTA
                class="border border-white/20 bg-transparent text-white hover:bg-white/10"
                pagesHref={PRIMARY_CTA.pagesHref}
                prodHref={PRIMARY_CTA.prodHref}
                label={PRIMARY_CTA.label}
              />
            </div>
            <div class="space-y-1">
              <p>{program.subidLine}</p>
              <p>Status disclosure: {program.statusDisclosure}</p>
            </div>
          </footer>
        </article>
      ))}
    </div>
  </section>
</MainLayout>
