---
import BannerSlot from '../components/BannerSlot.astro';
import LinkCTA from '../components/LinkCTA.astro';
import Notices from '../components/Notices.astro';
import SEO from '../components/SEO.astro';
import MainLayout from '../layouts/MainLayout.astro';
import Hero from '../partials/home/Hero.astro';
import { PRIMARY_CTA } from '../data/copy';
import { formatDateStamp } from '../utils/links';
import { buildPagesJoinHref, allowsPagesJoin, isProgramApproved, type ProgramRecord } from '../utils/programs';
import programs from '../data/programs.json';
import { resolveProgramDetail, type ResolvedProgramDetail } from '../data/programDetails';
import { resolveProgramStatusMeta, type ProgramStatus } from '../data/programStatus';

type ProgramEntry = ProgramRecord & {
  key: string;
  type: string;
  status: ProgramStatus;
  join_base: string;
  subid_params: string[];
};

type Program = ProgramEntry & ResolvedProgramDetail;

type ProgramCard = Program & {
  joinHrefPages: string;
  joinHrefProd: string;
  joinDisabled: boolean;
  subidLine: string;
  statusLabel: string;
  statusBadgeClass: string;
  statusDisclosure: string;
  joinDisabledLabel: string;
};

const dateStamp = formatDateStamp();
const canonicalPath = '/compare';
const enrichedPrograms: Program[] = (programs as ProgramEntry[]).map((program) => ({
  ...program,
  ...resolveProgramDetail(program.key)
}));

const programCards: ProgramCard[] = enrichedPrograms
  .filter((program) => isProgramApproved(program) && allowsPagesJoin(program))
  .map((program) => {
    const slot = `compare_${program.key}`;
    const joinHrefPages = buildPagesJoinHref(program, {
      slot,
      src: slot,
      camp: 'compare',
      date: dateStamp
    });
    const joinHrefProd = joinHrefPages;
    const statusMeta = resolveProgramStatusMeta(program.status);
    const joinDisabled =
      !statusMeta.allowsJoin || !allowsPagesJoin(program) || !/^https?:\/\//i.test(joinHrefPages ?? '');

    return {
      ...program,
      joinHrefPages,
      joinHrefProd,
      joinDisabled,
      subidLine:
        program.subid_params.length > 0
          ? `SubID params: ${program.subid_params.slice(0, 1).join(', ')}`
          : 'No subID params yet.',
      statusLabel: statusMeta.label,
      statusBadgeClass: statusMeta.badgeClass,
      statusDisclosure: statusMeta.disclosure,
      joinDisabledLabel: statusMeta.joinDisabledLabel
    };
  });
---

<MainLayout title="Compare cam platforms" description="Compare cam platforms tailored for new creators launching with NaughtyCamSpot.">
  <SEO
    slot="head"
    title="Cam program compare | NaughtyCamSpot"
    description="Review concierge-approved cam program readiness, geo allowances, and guarded join paths in one table."
    path={canonicalPath}
  />
  <Hero />
  <section class="space-y-8">
    <Notices />
    <div class="space-y-4">
      <h1 class="font-display text-4xl text-white sm:text-5xl">Compare cam platforms for new creators</h1>
      <p class="max-w-3xl text-base text-white/70">
        These quick-reference cards show our current onboarding guardrails. Use them to decide where to launch, then join via the
        guarded links so we can ship your StartRight kit.
      </p>
    </div>
    <div class="flex justify-center">
      <BannerSlot id="compare_top_leaderboard" class="max-w-full" placement="compare-platform-breakdown" />
    </div>
    <div class="grid gap-8 lg:grid-cols-3">
      {programCards.map((program) => (
        <article class="flex h-full flex-col gap-6 rounded-[32px] border border-white/10 bg-white/5 p-6 backdrop-blur-2xl">
          <header class="space-y-3">
            <div class="flex items-center justify-between gap-3">
              <h2 class="font-display text-2xl text-white">{program.name}</h2>
              <span
                class={`rounded-full px-3 py-1 text-[0.55rem] uppercase tracking-[0.3em] ${program.statusBadgeClass}`}
              >
                {program.statusLabel}
              </span>
            </div>
            <div class="flex flex-wrap gap-2 text-[0.65rem] uppercase tracking-[0.3em] text-white/60">
              <span class="rounded-full border border-white/15 px-3 py-1">Payout: {program.payout}</span>
              <span class="rounded-full border border-white/15 px-3 py-1">KYC: {program.kyc}</span>
              <span class="rounded-full border border-white/15 px-3 py-1">Traffic: {program.traffic}</span>
            </div>
          </header>
          <div class="space-y-4 text-sm text-white/70">
            <div>
              <p class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">Best for</p>
              <ul class="mt-2 space-y-1 list-disc pl-5">
                {program.best_for.map((item) => (
                  <li>{item}</li>
                ))}
              </ul>
            </div>
            <div>
              <p class="text-xs uppercase tracking-[0.35em] text-rose-petal/70">GEO notes</p>
              <p>{program.geo}</p>
            </div>
          </div>
          <footer class="mt-auto space-y-4 text-xs text-white/50">
            <div class="flex flex-col gap-3 sm:flex-row">
              {program.joinDisabled ? (
                <span class="inline-flex items-center justify-center rounded-full border border-white/15 bg-white/5 px-6 py-3 text-xs uppercase tracking-[0.3em] text-white/40">
                  {program.joinDisabledLabel}
                </span>
              ) : (
                <LinkCTA
                  class="border border-rose-gold/60 bg-rose-gold text-midnight"
                  pagesHref={program.joinHrefPages}
                  prodHref={program.joinHrefProd}
                  label="Join with our links"
                />
              )}
              <LinkCTA
                class="border border-white/20 bg-transparent text-white hover:bg-white/10"
                pagesHref={PRIMARY_CTA.pagesHref}
                prodHref={PRIMARY_CTA.prodHref}
                label={PRIMARY_CTA.label}
              />
            </div>
            <div class="space-y-1">
              <p>{program.subidLine}</p>
              <p>Status disclosure: {program.statusDisclosure}</p>
            </div>
          </footer>
        </article>
      ))}
    </div>
  </section>
</MainLayout>
