---
const {
  title = 'NaughtyCamSpot',
  description = 'NaughtyCamSpot -- concierge growth for ambitious cam models.',
  showNavigation = true
} = Astro.props;
import LinkCTA from '../components/LinkCTA.astro';
import '../styles/tailwind.css';
import { DISCLOSURE, PRIMARY_CTA } from '../data/copy';
import { NAV_MORE, NAV_PRIMARY } from '../data/nav';
import { withBase } from '../utils/links';

const baseUrl = typeof import.meta.env.BASE_URL === 'string' ? import.meta.env.BASE_URL : '/';
const isPagesFlag = typeof import.meta.env.IS_PAGES === 'string' ? import.meta.env.IS_PAGES === 'true' : false;
const isPagesBuild = isPagesFlag || baseUrl !== '/';

const resolveHostname = (value) => {
  if (!value) {
    return '';
  }

  try {
    return new URL(value).hostname;
  } catch {
    return String(value).replace(/^https?:\/\//, '').split('/')[0];
  }
};

const siteHostname = resolveHostname(import.meta.env.SITE ?? '');
const isProdSite = siteHostname === 'naughtycamspot.com';
const shouldTrackClicks = isProdSite && !isPagesBuild;
const gaMeasurementId =
  typeof import.meta.env.PUBLIC_GA4_ID === 'string'
    ? import.meta.env.PUBLIC_GA4_ID.trim()
    : '';
const shouldLoadAnalytics = shouldTrackClicks && gaMeasurementId.length > 0;
const organizationJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: 'NaughtyCamSpot',
  url: import.meta.env.SITE ?? 'https://naughtycamspot.com'
};

const currentPath = Astro.url.pathname.replace(/\/+$/, '') || '/';

const isNavActive = (href: string) => {
  const normalizedHref = href.replace(/\/+$/, '') || '/';
  if (normalizedHref === '/') {
    return currentPath === '/';
  }
  return currentPath === normalizedHref || currentPath.startsWith(`${normalizedHref}/`);
};

const resolveNavHref = (link) => {
  if (isPagesBuild && typeof link.pagesHref === 'string') {
    return link.pagesHref;
  }
  if (!isPagesBuild && typeof link.prodHref === 'string') {
    return link.prodHref;
  }
  return link.href;
};

const moreMenuActive = NAV_MORE.some((link) => isNavActive(resolveNavHref(link)));

const footerLinks = [
  ...NAV_MORE,
  { href: '/about', label: 'About' },
  { href: '/privacy', label: 'Privacy' },
  { href: '/terms', label: 'Terms' },
  { href: '/contact', label: 'Contact' }
];

const mainTopPadding = showNavigation ? 'pt-10' : 'pt-20';
---
<!doctype html>
<html lang="en" class="bg-midnight">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <base href={import.meta.env.BASE_URL} />
    <slot name="head">
      <title>{title}</title>
      <meta name="description" content={description} />
    </slot>
    {isPagesBuild && <meta name="robots" content="noindex,nofollow" />}
  <script type="application/ld+json" set:html={JSON.stringify(organizationJsonLd)} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet" />
    {shouldLoadAnalytics && (
      <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${gaMeasurementId}`}></script>
        <script is:inline>
          {`window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', '${gaMeasurementId}');`}
        </script>
      </>
    )}
  </head>
  <body class="relative min-h-screen overflow-x-hidden bg-midnight text-white">
    <div class="pointer-events-none fixed inset-0 z-0 bg-aurora opacity-80"></div>
    <div class="pointer-events-none absolute -left-24 top-32 h-72 w-72 rounded-full bg-rose-gold/20 blur-3xl"></div>
    <div class="pointer-events-none absolute -right-32 top-12 h-80 w-80 rounded-full bg-rose-gold/25 blur-3xl"></div>

    <div class="relative z-10 flex min-h-screen flex-col">
      {showNavigation && (
        <header class="mx-auto flex w-full max-w-6xl flex-col gap-5 px-6 pt-10 lg:flex-row lg:items-center lg:justify-between lg:gap-6" data-site-nav>
          <div class="flex w-full items-center justify-between gap-3">
            <a
              href={withBase('/')}
              class="flex items-center gap-3 text-sm font-semibold uppercase tracking-[0.32em] text-rose-gold"
            >
              <span class="flex h-11 w-11 items-center justify-center rounded-full border border-rose-gold/60 bg-white/10 shadow-glow backdrop-blur-lg">
                N
              </span>
              NaughtyCamSpot
            </a>
            <div class="flex items-center gap-3">
              <button
                type="button"
                class="rounded-full border border-white/20 bg-white/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.28em] text-white/70 shadow-glow backdrop-blur-xl transition hover:border-white/30 hover:text-rose-gold focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rose-gold lg:hidden"
                data-nav-mobile-toggle
                aria-expanded="false"
                aria-controls="mobile-navigation"
              >
                Menu
              </button>
              <LinkCTA
                class="border border-rose-gold/40 bg-rose-gold/20 px-5 py-2 text-rose-petal shadow-glow backdrop-blur-xl hover:border-rose-gold/60 hover:bg-rose-gold/30"
                pagesHref={PRIMARY_CTA.pagesHref}
                prodHref={PRIMARY_CTA.prodHref}
                label={PRIMARY_CTA.label}
              />
            </div>
          </div>
          <nav class="hidden w-full items-center justify-center gap-3 rounded-full border border-white/10 bg-white/10 px-4 py-3 text-[0.65rem] uppercase tracking-[0.25em] text-white/70 backdrop-blur-2xl sm:gap-4 sm:text-[0.7rem] sm:tracking-[0.28em] lg:flex lg:flex-nowrap lg:text-sm lg:tracking-[0.3em]" aria-label="Primary">
            {NAV_PRIMARY.map((link) => {
              const resolvedHref = resolveNavHref(link);
              const active = isNavActive(resolvedHref);
              return (
                <a
                  class={`whitespace-nowrap transition hover:text-rose-gold ${active ? 'text-rose-gold' : ''}`}
                  href={withBase(resolvedHref)}
                  aria-current={active ? 'page' : undefined}
                >
                  {link.label}
                </a>
              );
            })}
            <div class="relative" data-nav-more>
              <button
                type="button"
                class={`flex items-center gap-2 whitespace-nowrap rounded-full border border-transparent px-4 py-2 text-[0.65rem] font-semibold uppercase tracking-[0.25em] transition hover:text-rose-gold focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rose-gold lg:text-sm lg:tracking-[0.3em] ${moreMenuActive ? 'text-rose-gold' : 'text-white/70'}`}
                data-nav-more-trigger
                aria-haspopup="menu"
                aria-expanded="false"
              >
                More
              </button>
              <div
                class="pointer-events-none invisible absolute right-0 top-full mt-3 w-56 origin-top-right rounded-3xl border border-white/10 bg-black/90 p-3 opacity-0 shadow-glow backdrop-blur-2xl transition [--menu-duration:150ms]"
                data-nav-more-panel
                role="menu"
                tabindex="-1"
              >
                <ul class="flex flex-col gap-2 text-[0.65rem] uppercase tracking-[0.25em] text-white/70 lg:text-xs lg:tracking-[0.28em]">
                  {NAV_MORE.map((link) => {
                    const resolvedHref = resolveNavHref(link);
                    return (
                      <li>
                        <a
                          class="block rounded-full px-4 py-2 transition hover:bg-white/10 hover:text-rose-gold"
                          href={withBase(resolvedHref)}
                          role="menuitem"
                        >
                          {link.label}
                        </a>
                      </li>
                    );
                  })}
                </ul>
              </div>
            </div>
          </nav>
          <div class="lg:hidden">
            <div
              class="fixed inset-0 z-40 hidden bg-black/70 opacity-0 transition-opacity duration-200"
              data-nav-mobile-overlay
            ></div>
            <div
              id="mobile-navigation"
              class="fixed inset-y-0 right-0 z-50 flex w-80 max-w-full translate-x-full flex-col gap-6 bg-black/95 p-6 text-sm uppercase tracking-[0.32em] text-white/70 shadow-glow transition-transform duration-200"
              data-nav-mobile-drawer
            >
              <div class="flex items-center justify-between">
                <span class="text-xs font-semibold tracking-[0.28em] text-white/60">Navigation</span>
                <button
                  type="button"
                  class="rounded-full border border-white/20 px-3 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.25em] text-white/70 transition hover:border-white/30 hover:text-rose-gold focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rose-gold"
                  data-nav-mobile-close
                  aria-label="Close menu"
                >
                  Close
                </button>
              </div>
              <nav class="flex flex-col gap-3 text-white/70" aria-label="Mobile primary">
                {NAV_PRIMARY.map((link) => {
                  const resolvedHref = resolveNavHref(link);
                  const active = isNavActive(resolvedHref);
                  return (
                    <a
                      class={`rounded-full border border-white/10 px-4 py-3 text-[0.65rem] tracking-[0.28em] transition hover:border-white/20 hover:text-rose-gold ${active ? 'border-rose-gold/50 text-rose-gold' : 'text-white/70'}`}
                      href={withBase(resolvedHref)}
                      data-nav-mobile-link
                      aria-current={active ? 'page' : undefined}
                    >
                      {link.label}
                    </a>
                  );
                })}
              </nav>
              <div class="flex flex-col gap-3" data-nav-mobile-more>
                <button
                  type="button"
                  class={`flex items-center justify-between rounded-full border px-4 py-3 text-[0.65rem] tracking-[0.28em] transition hover:border-white/20 hover:text-rose-gold ${moreMenuActive ? 'border-rose-gold/50 text-rose-gold' : 'border-white/10 text-white/70'}`}
                  data-nav-mobile-more-trigger
                  aria-expanded="false"
                >
                  <span>More</span>
                  <span aria-hidden="true">▾</span>
                </button>
                <div class="hidden flex-col gap-2 text-[0.65rem] tracking-[0.28em] text-white/70" data-nav-mobile-more-panel>
                  {NAV_MORE.map((link) => {
                    const resolvedHref = resolveNavHref(link);
                    const active = isNavActive(resolvedHref);
                    return (
                      <a
                        class={`rounded-full border border-white/10 px-4 py-3 transition hover:border-white/20 hover:text-rose-gold ${active ? 'border-rose-gold/50 text-rose-gold' : 'text-white/70'}`}
                        href={withBase(resolvedHref)}
                        data-nav-mobile-link
                      >
                        {link.label}
                      </a>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>
        </header>
      )}

      <main class={`relative mx-auto flex w-full max-w-6xl flex-1 flex-col gap-24 px-6 pb-24 ${mainTopPadding}`}>
        <slot />
      </main>

      <footer class="border-t border-white/10 bg-black/40 py-10 backdrop-blur-2xl">
        <div class="mx-auto flex w-full max-w-6xl flex-col gap-3 px-6 text-xs uppercase tracking-[0.4em] text-white/45 sm:flex-row sm:items-center sm:justify-between">
          <div class="flex flex-wrap items-center gap-4 text-[0.7rem]">
            {footerLinks.map((link) => {
              const resolvedHref = resolveNavHref(link);
              return (
                <a class="transition hover:text-rose-gold" href={withBase(resolvedHref)}>
                  {link.label}
                </a>
              );
            })}
          </div>
          <div class="flex items-center gap-4 text-[0.7rem]">
            <a class="transition hover:text-rose-gold" href="mailto:concierge@naughtycamspot.com">
              concierge@naughtycamspot.com
            </a>
            <span>© NaughtyCamSpot 2025</span>
          </div>
          <p class="text-[0.65rem] uppercase tracking-[0.4em] text-white/40">{DISCLOSURE}</p>
        </div>
      </footer>
    </div>
    {showNavigation && (
      <script is:inline>
        {`(function(){
  const navRoot = document.querySelector('[data-site-nav]');
  if (!navRoot) {
    return;
  }

  const moreContainer = navRoot.querySelector('[data-nav-more]');
  const moreButton = moreContainer ? moreContainer.querySelector('[data-nav-more-trigger]') : null;
  const morePanel = moreContainer ? moreContainer.querySelector('[data-nav-more-panel]') : null;
  const moreLinks = morePanel ? Array.from(morePanel.querySelectorAll('a[href]')) : [];
  const mobileToggle = navRoot.querySelector('[data-nav-mobile-toggle]');
  const mobileDrawer = navRoot.querySelector('[data-nav-mobile-drawer]');
  const mobileOverlay = navRoot.querySelector('[data-nav-mobile-overlay]');
  const mobileClose = navRoot.querySelector('[data-nav-mobile-close]');
  const mobileLinks = navRoot.querySelectorAll('[data-nav-mobile-link]');
  const mobileMoreTrigger = navRoot.querySelector('[data-nav-mobile-more-trigger]');
  const mobileMorePanel = navRoot.querySelector('[data-nav-mobile-more-panel]');

  let moreOpen = false;
  let drawerOpen = false;
  let mobileMoreOpen = false;
  let moreHoverTimer = null;

  const getMoreFocusable = () => {
    if (!morePanel) {
      return [];
    }
    return Array.from(
      morePanel.querySelectorAll(
        'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])'
      )
    );
  };

  const focusMoreFirstItem = () => {
    if (!moreButton || document.activeElement !== moreButton) {
      return;
    }
    const focusable = getMoreFocusable();
    if (focusable.length > 0) {
      focusable[0].focus();
      return;
    }
    if (morePanel) {
      morePanel.focus();
    }
  };

  const handleMoreKeydown = (event) => {
    if (event.key !== 'Tab') {
      return;
    }
    const focusable = getMoreFocusable();
    if (focusable.length === 0) {
      return;
    }
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    const active = document.activeElement;
    if (event.shiftKey) {
      if (active === first) {
        event.preventDefault();
        last.focus();
      }
    } else if (active === last) {
      event.preventDefault();
      first.focus();
    }
  };

  const setMoreOpen = (open) => {
    if (!moreButton || !morePanel) {
      return;
    }
    if (moreOpen === open) {
      return;
    }
    moreOpen = open;
    moreButton.setAttribute('aria-expanded', open ? 'true' : 'false');
    if (open) {
      morePanel.classList.remove('pointer-events-none');
      morePanel.classList.remove('invisible');
      window.requestAnimationFrame(() => {
        morePanel.classList.remove('opacity-0');
      });
      focusMoreFirstItem();
      morePanel.addEventListener('keydown', handleMoreKeydown);
    } else {
      morePanel.classList.add('pointer-events-none');
      morePanel.classList.add('opacity-0');
      window.setTimeout(() => {
        if (!moreOpen) {
          morePanel.classList.add('invisible');
        }
      }, 150);
      morePanel.removeEventListener('keydown', handleMoreKeydown);
      const active = document.activeElement;
      if (active && (active === moreButton || (morePanel && morePanel.contains(active)))) {
        moreButton.focus({ preventScroll: true });
      }
    }
  };

  const closeMore = () => setMoreOpen(false);

  const handleDocumentClick = (event) => {
    if (!moreOpen || !moreContainer) {
      return;
    }
    if (moreContainer.contains(event.target)) {
      return;
    }
    closeMore();
  };

  const handleEscape = (event) => {
    if (event.key !== 'Escape') {
      return;
    }
    if (moreOpen) {
      closeMore();
    }
    if (drawerOpen) {
      setDrawerOpen(false);
    }
  };

  const setMobileMoreOpen = (open) => {
    if (!mobileMoreTrigger || !mobileMorePanel) {
      return;
    }
    mobileMoreOpen = open;
    mobileMoreTrigger.setAttribute('aria-expanded', open ? 'true' : 'false');
    if (open) {
      mobileMorePanel.classList.remove('hidden');
    } else {
      mobileMorePanel.classList.add('hidden');
    }
  };

  const setDrawerOpen = (open) => {
    if (!mobileDrawer || !mobileOverlay) {
      return;
    }
    if (drawerOpen === open) {
      return;
    }
    drawerOpen = open;
    if (mobileToggle) {
      mobileToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
    }
    if (open) {
      mobileOverlay.classList.remove('hidden');
      mobileOverlay.classList.add('opacity-0');
      window.requestAnimationFrame(() => {
        mobileOverlay.classList.remove('opacity-0');
        mobileOverlay.classList.add('opacity-100');
        mobileDrawer.classList.remove('translate-x-full');
      });
      document.body.classList.add('overflow-hidden');
    } else {
      mobileOverlay.classList.remove('opacity-100');
      mobileOverlay.classList.add('opacity-0');
      mobileDrawer.classList.add('translate-x-full');
      document.body.classList.remove('overflow-hidden');
      window.setTimeout(() => {
        if (!drawerOpen) {
          mobileOverlay.classList.add('hidden');
        }
      }, 200);
      setMobileMoreOpen(false);
      const active = document.activeElement;
      if (
        active &&
        mobileMoreTrigger &&
        mobileDrawer &&
        mobileDrawer.contains(active)
      ) {
        mobileMoreTrigger.focus({ preventScroll: true });
      }
    }
  };

  if (moreButton && morePanel) {
    moreButton.addEventListener('click', () => {
      setMoreOpen(!moreOpen);
    });
    if (moreContainer) {
      const openOnHover = () => {
        window.clearTimeout(moreHoverTimer);
        setMoreOpen(true);
      };
      const closeOnLeave = () => {
        window.clearTimeout(moreHoverTimer);
        moreHoverTimer = window.setTimeout(() => {
          setMoreOpen(false);
        }, 100);
      };
      moreContainer.addEventListener('mouseenter', openOnHover);
      moreContainer.addEventListener('mouseleave', closeOnLeave);
    }
    document.addEventListener('click', handleDocumentClick);
    if (moreLinks.length > 0) {
      moreLinks.forEach((link) => {
        link.addEventListener('click', closeMore);
      });
    }
  }

  if (mobileToggle) {
    mobileToggle.addEventListener('click', () => {
      setDrawerOpen(!drawerOpen);
    });
  }

  if (mobileOverlay) {
    mobileOverlay.addEventListener('click', () => setDrawerOpen(false));
  }

  if (mobileClose) {
    mobileClose.addEventListener('click', () => setDrawerOpen(false));
  }

  if (mobileLinks && mobileLinks.length > 0) {
    mobileLinks.forEach((link) => {
      link.addEventListener('click', () => setDrawerOpen(false));
    });
  }

  if (mobileMoreTrigger) {
    mobileMoreTrigger.addEventListener('click', () => {
      setMobileMoreOpen(!mobileMoreOpen);
    });
  }

  const handleResize = () => {
    if (window.innerWidth >= 1024) {
      setDrawerOpen(false);
      document.body.classList.remove('overflow-hidden');
    }
  };

  window.addEventListener('keydown', handleEscape);
  window.addEventListener('resize', handleResize);
})();`}
      </script>
    )}
    {shouldTrackClicks && (
      <script is:inline>
        {`(function(){
  const endpoint = `/${String.fromCharCode(103, 111)}/click.php`;
  const sendBeacon = (slot, camp) => {
    const params = new URLSearchParams({
      e: 'click',
      src: slot || 'unknown',
      camp: camp || 'unknown',
      t: String(Date.now())
    });
    const url = endpoint + '?' + params.toString();
    if (navigator.sendBeacon) {
      navigator.sendBeacon(url);
      return;
    }
    try {
      fetch(url, { method: 'GET', mode: 'no-cors', keepalive: true });
    } catch (_) {
      // Swallow network errors — analytics should never block navigation.
    }
  };

  document.addEventListener('click', (event) => {
    const target = event.target instanceof Element ? event.target.closest('[data-track="click"]') : null;
    if (!target) {
      return;
    }

    const slot = target.getAttribute('data-slot') || '';
    const camp = target.getAttribute('data-camp') || '';
    sendBeacon(slot, camp);
  }, { capture: true });
})();`}
      </script>
    )}
  </body>
</html>
