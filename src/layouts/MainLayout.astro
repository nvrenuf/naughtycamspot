---
const {
  title = 'NaughtyCamSpot',
  description = 'Signup Help (Free) plus Promotion (Paid) services for cam models.',
  showNavigation = true
} = Astro.props;
import LinkCTA from '../components/LinkCTA.astro';
import PreClickCapture from '../components/PreClickCapture.astro';
import '../styles/tailwind.css';
import { DISCLOSURE, PRIMARY_CTA } from '../data/copy';
import { NAV_PRIMARY } from '../data/nav';
import { withBase } from '../utils/links';
import { getRequestLang, LANGS } from '../i18n/core';
import buildStamp from '../generated/build-stamp.json';

const baseUrl = typeof import.meta.env.BASE_URL === 'string' ? import.meta.env.BASE_URL : '/';
const isPagesFlag = typeof import.meta.env.IS_PAGES === 'string' ? import.meta.env.IS_PAGES === 'true' : false;
const isPagesBuild = isPagesFlag || baseUrl !== '/';

const resolveHostname = (value) => {
  if (!value) {
    return '';
  }

  try {
    return new URL(value).hostname;
  } catch {
    return String(value).replace(/^https?:\/\//, '').split('/')[0];
  }
};

const siteHostname = resolveHostname(import.meta.env.SITE ?? '');
const isProdSite = siteHostname === 'naughtycamspot.com';
const shouldTrackClicks = isProdSite && !isPagesBuild;
const gaMeasurementId =
  typeof import.meta.env.PUBLIC_GA4_ID === 'string'
    ? import.meta.env.PUBLIC_GA4_ID.trim()
    : '';
const shouldLoadAnalytics = shouldTrackClicks && gaMeasurementId.length > 0;
const organizationJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: 'NaughtyCamSpot',
  url: import.meta.env.SITE ?? 'https://naughtycamspot.com'
};

const normalizePath = (value?: string) => {
  if (!value) {
    return '';
  }
  const trimmed = value.replace(/\/+$/, '');
  return trimmed.length === 0 ? '/' : trimmed;
};

const normalizedBasePath = normalizePath(baseUrl) || '/';
const stripBase = (value: string) => {
  const normalized = normalizePath(value);
  if (normalizedBasePath !== '/' && normalized.startsWith(normalizedBasePath)) {
    const remainder = normalized.slice(normalizedBasePath.length);
    return normalizePath(remainder) || '/';
  }
  return normalized || '/';
};

const currentPath = stripBase(Astro.url.pathname);
const requestLang = getRequestLang(Astro.url);
const buildLangHref = (lang: string) => {
  const params = new URLSearchParams(Astro.url.searchParams);
  if (lang === 'en') {
    params.delete('lang');
  } else {
    params.set('lang', lang);
  }
  const qs = params.toString();
  return qs ? `?${qs}` : '';
};

const primaryNavLinks = NAV_PRIMARY;

const isNavActive = (href: string) => {
  const normalizedHref = stripBase(href);
  if (normalizedHref === '/') {
    return currentPath === '/';
  }
  return currentPath === normalizedHref || currentPath.startsWith(`${normalizedHref}/`);
};

const resolveNavHref = (link) => {
  if (isPagesBuild && typeof link.pagesHref === 'string') {
    return link.pagesHref;
  }
  if (!isPagesBuild && typeof link.prodHref === 'string') {
    return link.prodHref;
  }
  return link.href;
};

const footerLinks = [
  { href: '/how-it-works/', label: 'How It Works' },
  { href: '/startright/', label: 'StartRight' },
  { href: '/recruiting/', label: 'Signup Help (Free)' },
  { href: '/promotion/', label: 'Promotion (Paid)' },
  { href: '/resources/', label: 'Resources' },
  { href: '/resources/platforms/', label: 'Platform Guides' },
  { href: '/gear-kits/', label: 'Gear Kits' },
  { href: '/community/', label: 'Community' },
  { href: '/events/', label: 'Events' },
  { href: '/library/', label: 'Library' },
  { href: '/blog/', label: 'Blog' },
  { href: '/posts/', label: 'Posts' },
  { href: '/earnings/', label: 'Earnings' },
  { href: '/trust-safety/', label: 'Trust & Safety' },
  { href: '/privacy/', label: 'Privacy' },
  { href: '/terms/', label: 'Terms' },
  { href: '/disclosure/', label: 'Disclosure' }
];

const mainTopPadding = showNavigation ? 'pt-10' : 'pt-20';
const buildStampValue = typeof buildStamp?.stamp === 'string' ? buildStamp.stamp : 'dev|dev';
const buildCommit = typeof buildStamp?.shortSha === 'string' ? buildStamp.shortSha : 'dev';
const buildDisplay = typeof buildStamp?.displayUtc === 'string' ? buildStamp.displayUtc : 'dev';
---
<!doctype html>
<html lang="en" class="bg-midnight">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <base href={import.meta.env.BASE_URL} />
	    <slot name="head">
	      <title>{title}</title>
	      <meta name="description" content={description} />
	    </slot>
	    <link rel="icon" type="image/svg+xml" href="/brand/ncs-icon.svg" />
	    <meta name="ncs-build" content={buildStampValue} />
	    <meta name="ncs-commit" content={buildCommit} />
	    {isPagesBuild && <meta name="robots" content="noindex,nofollow" />}
	  <script type="application/ld+json" set:html={JSON.stringify(organizationJsonLd)} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet" />
    {shouldLoadAnalytics && (
      <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${gaMeasurementId}`}></script>
        <script is:inline>
          {`window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', '${gaMeasurementId}');`}
        </script>
      </>
    )}
  </head>
  <body class="relative min-h-screen overflow-x-hidden bg-midnight text-white">
    <div class="pointer-events-none fixed inset-0 z-0 bg-aurora opacity-80"></div>
    <div class="pointer-events-none absolute -left-24 top-32 h-72 w-72 rounded-full bg-rose-gold/20 blur-3xl"></div>
    <div class="pointer-events-none absolute -right-32 top-12 h-80 w-80 rounded-full bg-rose-gold/25 blur-3xl"></div>
    <PreClickCapture />

    <div class="relative z-10 flex min-h-screen flex-col">
      {showNavigation && (
        <header class="relative z-30 mx-auto flex w-full max-w-6xl flex-col gap-5 px-6 pt-10 lg:flex-row lg:items-center lg:justify-between lg:gap-6" data-site-nav>
          <div class="flex w-full items-center justify-between gap-3">
            <a
              href={withBase('/')}
              class="inline-flex items-center gap-3 rounded-lg text-rose-gold focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rose-gold"
            >
              <img
                src="/brand/ncs-logo-primary.svg"
                alt="NaughtyCamSpot"
                class="h-8 w-auto select-none md:h-10"
                width="200"
                height="40"
                loading="eager"
                decoding="async"
              />
            </a>
            <div class="flex items-center gap-3">
              <button
                type="button"
                class="rounded-full border border-white/20 bg-white/10 px-4 py-2 text-sm font-semibold tracking-[0.06em] text-white/80 shadow-glow backdrop-blur-xl transition hover:border-white/30 hover:text-rose-gold focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rose-gold lg:hidden"
                data-nav-mobile-toggle
                aria-expanded="false"
                aria-controls="mobile-navigation"
              >
                Menu
              </button>
              <LinkCTA
                class="border border-rose-gold/40 bg-rose-gold/20 px-5 py-2 text-rose-petal shadow-glow backdrop-blur-xl hover:border-rose-gold/60 hover:bg-rose-gold/30"
                pagesHref={PRIMARY_CTA.pagesHref}
                prodHref={PRIMARY_CTA.prodHref}
                label={PRIMARY_CTA.label}
              />
            </div>
          </div>
          <nav class="hidden w-full items-center justify-center gap-3 rounded-full border border-white/10 bg-white/10 px-4 py-3 text-sm tracking-[0.06em] text-white/80 backdrop-blur-2xl sm:gap-4 lg:flex lg:flex-nowrap" aria-label="Primary Navigation">
            {primaryNavLinks.map((link) => {
              const resolvedHref = resolveNavHref(link);
              const active = isNavActive(resolvedHref);
              return (
                <a
                  class={`whitespace-nowrap transition hover:text-rose-gold ${active ? 'text-rose-gold' : ''}`}
                  href={withBase(resolvedHref)}
                  aria-current={active ? 'page' : undefined}
                >
                  {link.label}
                </a>
              );
            })}
          </nav>
          <div class="lg:hidden">
            <div
              class="fixed inset-0 z-40 hidden bg-black/70 opacity-0 transition-opacity duration-200"
              data-nav-mobile-overlay
            ></div>
            <div
              id="mobile-navigation"
              class="fixed inset-y-0 right-0 z-50 flex w-80 max-w-full translate-x-full flex-col gap-6 bg-black/95 p-6 text-base tracking-[0.06em] text-white/80 shadow-glow transition-transform duration-200"
              data-nav-mobile-drawer
            >
              <div class="flex items-center justify-between">
                <span class="text-sm font-semibold tracking-[0.06em] text-white/80">Navigation</span>
                <button
                  type="button"
                  class="rounded-full border border-white/20 px-3 py-1 text-sm font-semibold tracking-[0.06em] text-white/80 transition hover:border-white/30 hover:text-rose-gold focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rose-gold"
                  data-nav-mobile-close
                  aria-label="Close menu"
                >
                  Close
                </button>
              </div>
              <nav class="flex flex-col gap-3 text-white/70" aria-label="Mobile primary">
                {primaryNavLinks.map((link) => {
                  const resolvedHref = resolveNavHref(link);
                  const active = isNavActive(resolvedHref);
                  return (
                    <a
                      class={`rounded-full border border-white/10 px-4 py-3 text-sm tracking-[0.06em] transition hover:border-white/20 hover:text-rose-gold ${active ? 'border-rose-gold/50 text-rose-gold' : 'text-white/80'}`}
                      href={withBase(resolvedHref)}
                      data-nav-mobile-link
                      aria-current={active ? 'page' : undefined}
                    >
                      {link.label}
                    </a>
                  );
                })}
              </nav>
            </div>
          </div>
        </header>
      )}

      <main class={`relative mx-auto flex w-full max-w-6xl flex-1 flex-col gap-24 px-6 pb-24 ${mainTopPadding}`}>
        <slot />
      </main>

      <footer class="border-t border-white/10 bg-black/40 py-10 backdrop-blur-2xl">
        <div class="mx-auto flex w-full max-w-6xl flex-col gap-3 px-6 text-sm tracking-[0.04em] text-white/70 sm:flex-row sm:items-center sm:justify-between">
          <div class="flex flex-wrap items-center gap-4 text-sm">
            {footerLinks.map((link) => {
              const resolvedHref = resolveNavHref(link);
              return (
                <a class="transition hover:text-rose-gold" href={withBase(resolvedHref)}>
                  {link.label}
                </a>
              );
            })}
          </div>
          <div class="flex items-center gap-4 text-sm">
            <a class="transition hover:text-rose-gold" href="mailto:concierge@naughtycamspot.com">
              concierge@naughtycamspot.com
            </a>
            <span>© NaughtyCamSpot 2025</span>
          </div>
          <p class="text-xs text-white/50">Build: {buildCommit} • {buildDisplay}</p>
          <div class="flex flex-wrap items-center gap-2 text-xs uppercase tracking-[0.28em] text-white/60">
            <span class="text-white/50">Lang</span>
            {LANGS.map((lang) => (
              <a
                class={`rounded-full border px-3 py-1 transition hover:border-white/30 hover:text-rose-gold ${requestLang === lang ? 'border-rose-gold/60 text-rose-gold' : 'border-white/10 text-white/70'}`}
                href={buildLangHref(lang)}
                aria-current={requestLang === lang ? 'true' : undefined}
              >
                {lang.toUpperCase()}
              </a>
            ))}
          </div>
          <p class="text-xs tracking-[0.04em] text-white/65">{DISCLOSURE}</p>
        </div>
      </footer>
	    </div>
	    {showNavigation && (
	      <script is:inline>
	        (function(){
	  const navRoot = document.querySelector('[data-site-nav]');
	  if (!navRoot) {
	    return;
	  }

  const mobileToggle = navRoot.querySelector('[data-nav-mobile-toggle]');
  const mobileDrawer = navRoot.querySelector('[data-nav-mobile-drawer]');
  const mobileOverlay = navRoot.querySelector('[data-nav-mobile-overlay]');
  const mobileClose = navRoot.querySelector('[data-nav-mobile-close]');
  const mobileLinks = navRoot.querySelectorAll('[data-nav-mobile-link]');

	  let drawerOpen = false;

  const setDrawerOpen = (open) => {
    if (!mobileDrawer || !mobileOverlay) {
      return;
    }
    if (drawerOpen === open) {
      return;
    }
    drawerOpen = open;
    if (mobileToggle) {
      mobileToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
    }
    if (open) {
      mobileOverlay.classList.remove('hidden');
      mobileOverlay.classList.add('opacity-0');
      window.requestAnimationFrame(() => {
        mobileOverlay.classList.remove('opacity-0');
        mobileOverlay.classList.add('opacity-100');
        mobileDrawer.classList.remove('translate-x-full');
      });
      document.body.classList.add('overflow-hidden');
    } else {
      mobileOverlay.classList.remove('opacity-100');
      mobileOverlay.classList.add('opacity-0');
      mobileDrawer.classList.add('translate-x-full');
      document.body.classList.remove('overflow-hidden');
      window.setTimeout(() => {
        if (!drawerOpen) {
          mobileOverlay.classList.add('hidden');
        }
      }, 200);
    }
  };

  if (mobileToggle) {
    mobileToggle.addEventListener('click', () => {
      setDrawerOpen(!drawerOpen);
    });
  }

  if (mobileOverlay) {
    mobileOverlay.addEventListener('click', () => setDrawerOpen(false));
  }

  if (mobileClose) {
    mobileClose.addEventListener('click', () => setDrawerOpen(false));
  }

  if (mobileLinks && mobileLinks.length > 0) {
    mobileLinks.forEach((link) => {
      link.addEventListener('click', () => setDrawerOpen(false));
    });
  }

	  const handleGlobalEscape = (event) => {
	    if (event.key !== 'Escape') return;
	    if (drawerOpen) setDrawerOpen(false);
	  };

		  const handleResize = () => {
		    if (window.innerWidth >= 1024) {
		      setDrawerOpen(false);
		      document.body.classList.remove('overflow-hidden');
		    }
		  };

	  window.addEventListener('keydown', handleGlobalEscape);
	  window.addEventListener('resize', handleResize);
	})();
	      </script>
	    )}
	    {shouldTrackClicks && (
	      <script is:inline>
	        (function(){
	  const run = () => {
	  const endpoint = '/' + String.fromCharCode(103, 111) + '/click.php';
	  const sendBeacon = (slot, camp) => {
	    const params = new URLSearchParams({
	      e: 'click',
	      src: slot || 'unknown',
	      camp: camp || 'unknown',
	      t: String(Date.now())
	    });
	    const url = endpoint + '?' + params.toString();
	    if (navigator.sendBeacon) {
	      navigator.sendBeacon(url);
	      return;
	    }
	    try {
	      fetch(url, { method: 'GET', mode: 'no-cors', keepalive: true });
	    } catch (_) {
	      // Swallow network errors — analytics should never block navigation.
	    }
	  };

	  document.addEventListener('click', (event) => {
	    const target = event.target instanceof Element ? event.target.closest('[data-track="click"]') : null;
	    if (!target) {
	      return;
	    }

	    const slot = target.getAttribute('data-slot') || '';
	    const camp = target.getAttribute('data-camp') || '';
	    sendBeacon(slot, camp);
	  }, { capture: true });
	  };

	  if ('requestIdleCallback' in window) {
	    window.requestIdleCallback(run);
	  } else {
	    window.setTimeout(run, 0);
	  }
	})();
	      </script>
	    )}
	  </body>
	</html>
